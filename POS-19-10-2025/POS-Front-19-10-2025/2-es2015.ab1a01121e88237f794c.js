(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{"4o9x":function(e,t,r){"use strict";r.d(t,"a",function(){return V});var i=r("mrSG"),o=r("U2wp"),n=r("Mabr"),a=r("cOv9");class s{}var u=r("tiJv"),d=r("e3ir"),l=r("zyXO"),c=r("PSD3"),m=r.n(c),h=r("9qFR"),T=r("bJ22"),D=r("amrp"),P=r("L1NN"),g=r("eUyL"),y=r("b3ex"),I=r("kLqA"),v=r("un1/"),p=r("C5+t"),f=r("fXoL"),x=r("sF2B"),O=r("ig09"),S=r("5eHb"),b=r("E8vI"),C=r("tyNb"),A=r("sYmb");let V=(()=>{class e extends l.a{constructor(e,t,r,i,a,u){var d;super(),this.settingSer=e,this.orderSer=t,this.toastr=r,this.toastrMessage=i,this.router=a,this.translate=u,this.orderdetailobj=new o.a,this.orderPayTypelist=[],this.turkyPaymentSystems=[],this.settingobj=new n.a,this.allproductlist=[],this.userPermissions=[],this.Flds={text:"Name",value:"DocumentId"},this.DiscountFlds={text:"Value",value:"Id"},this.FldsWithId={text:"Name",value:"Id"},this.discountCategories=[],this.isPaymentPrintBtn=!1,this.IsCustomerHasPromo=!1,this.freeProducts=[],this.freeOrderDetail=new o.a,this.freeOrderDetails=[],this.selectedFreeProducts=[],this.integrationSettings=[],this.orderdetailpromoobj=new s,this.report=new Stimulsoft.Report.StiReport,this.counter=0,this.holdedOrdersKey="holdedOrders",this.pendingOrdersKey="pendingOrders",this.pendingOrders=[],this.pendingOrdersCount=0,Stimulsoft.Base.StiLicense.key="6vJhGtLLLz2GNviWmUTrhSqnOItdDwjBylQzQcAOiHlkHnETZDQa/PS+0KAqyGT4DpRlgFmGegaxKasr/6hj3WTsNszXi2AnvR96edDIZl0iQK5oAkmli4CDUblYqrhiAJUrUZtKyoZUOSwbjhyDdjuqCk8reDn/QTemFDwWuF4BfzOqXcdV9ceHmq8jqTiwrgF4Bc35HGUqPq+CnYqGQhfU3YY44xsR5JaAuLAXvuP05Oc6F9BQhBMqb6AUXjeD5T9OJWHiIacwv0LbxJAg5a1dVBDPR9E+nJu2dNxkG4EcLY4nf4tOvUh7uhose6Cp5nMlpfXUnY7k7Lq9r0XE/b+q1f11KCXK/t0GpGNnPL5Xy//JCUP7anSZ0SdSbuW8Spxp+r7StU/XLwt9vqKf5rsY9CN8D8u4Mc8RZiSXceDuKyhQo72Eu8yYFswP9COQ4lgOJGcaCv5h9GwR+Iva+coQENBQyY2dItFpsBwSAPvGs2/4V82ztLMsmkTpoAzYupvE2AoddxArDjjTMeyKowMI6qtTyhaF9zTnJ7X7gs09lgTg7Hey5I1Q66QFfcwK",this.GetSettings(),this.HelperFirstOpen(),this.currentUserLanguage=null===(d=JSON.parse(localStorage.getItem("langs")))||void 0===d?void 0:d.toLowerCase(),this.days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],this.refreshDateAndTime()}refreshDateAndTime(){this.currentMachineDayTime=new Date,this.currentMachineTime=this.getTimeString(this.currentMachineDayTime),this.currentMachineDay=this.days[this.currentMachineDayTime.getDay()].toLowerCase(),this.currentMachineDate=this.getOnlyDate(this.currentMachineDayTime)}isWeekDayIncluded(e,t){return e.filter(e=>e.Name.toLowerCase()==t.toLowerCase()&&e.IsWork)[0]}getTimeString(e){return e.toTimeString().split(" ")[0]}getOnlyDate(e){let t=e.getDate(),r=e.getMonth(),i=e.getFullYear();return new Date(i,r,t)}ngOnInit(){}GetSettings(){this.settingSer.GetSetting().subscribe(e=>{const t=e;this.settingobj=t,this.orderSer.settings=t})}HelperFirstOpen(){this.discountCategories=[{Value:5,Id:1},{Value:10,Id:2},{Value:15,Id:3},{Value:20,Id:4},{Value:25,Id:5},{Value:30,Id:6},{Value:40,Id:7},{Value:50,Id:8}],this.orderSer.HelperFirstOpen().subscribe(e=>{var t,r,i,o,n;this.categories=e.Item1,(null===(t=this.categories)||void 0===t?void 0:t.length)&&(this.categories=this.distinct(this.categories,"Value")),this.allorderPayTypelist=e.Item2,this.allorderPayTypelist.forEach(e=>{e.Name=this.getTypeName(e)}),this.orderPayTypelist=this.deepCopy(this.allorderPayTypelist),this.cashBackPayType=this.orderPayTypelist.find(e=>70===e.PayType),this.defaultSelectedPayType=this.orderPayTypelist[0],this.checkOrderTypePayment(this._orderobj),this.orderPayTypelist&&0!=this.orderPayTypelist.length||this.routIfMissingData("orderpaytype"),this.defaultLanguage=e.Item3.toLowerCase(),this.userPermissions=e.Item4,this.isAdmin=e.Item5,this.allTaxes=e.Item6,this.allinsurancelist=e.Item7,this.turkyPaymentSystems=null===(r=e.Rest)||void 0===r?void 0:r.Item1,this.customerPromos=null===(i=e.Rest)||void 0===i?void 0:i.Item2,this.minimumCharges=null===(o=e.Rest)||void 0===o?void 0:o.Item3,this.myPoint=null===(n=e.Rest)||void 0===n?void 0:n.Item4,this.insurancelist=this.cloneList(this.allinsurancelist)})}checkOrderTypePayment(e){e&&e.OrderType&&1==e.OrderType.MandatoryToSelectThisType&&(e.OrderType.OrderPayTypeDocumentId||e.OrderType.OrderPayTypeId)?(this.orderPayTypelist=this.deepCopy(this.allorderPayTypelist.filter(t=>e.OrderType.OrderPayTypeId&&t.Id==e.OrderType.OrderPayTypeId||e.OrderType.OrderPayTypeDocumentId&&t.DocumentId==e.OrderType.OrderPayTypeDocumentId)),!this.orderPayTypelist||1!=this.orderPayTypelist.length||20!=this.orderPayTypelist[0].PayType||e.CustomerDocumentId&&(e.EmployeeId||e.EmployeeDocumentId)||$("#modal-40444").modal("show")):(this.orderPayTypelist=this.deepCopy(this.allorderPayTypelist),e&&e.OrderType&&e.OrderType.MustHaveCustomer&&!e.CustomerDocumentId&&$("#modal-40444").modal("show"))}setFocusById(e){window.setTimeout(function(){let t=document.getElementById(e);t&&t.focus()},200)}getNetPrice(e,t=null,r=null){var i;let o=0,n=(null==r?void 0:r.EditedPrice)?null==r?void 0:r.EditedPrice:e.Price;t||(t=e),t.ProductTaxes||(t.ProductTaxes=[]),n=this.getProductVolumePriceForDetail(r,e,n);let a=t.ProductTaxes.filter(e=>e.Tax&&!e.Tax.ExtraTax);if(a&&a.length&&this.settingobj.PriceIncludesTax){const e=null===(i=a[0].Tax)||void 0===i?void 0:i.ValueType,t=a.map(e=>e.Tax.Value).reduce((e,t)=>Number(e)+Number(t));o=1==e?n/(1+t/100):n-t}else o=n;return o}getProductVolumePriceForDetail(e,t,r){var i,o;let n=this.deepCopy(t);if((null===(i=this.allproductlist)||void 0===i?void 0:i.length)&&(n=this.deepCopy(t.VolumeId||t.VolumeDocumentId||t.VolumeFerpCode?t:this.allproductlist.find(e=>e.DocumentId==t.DocumentId)),n||(n=this.deepCopy(t))),e&&e.DocumentId&&(e.VolumeId||e.VolumeDocumentId||e.VolumeFerpCode)){let i=t.ProductVolumes;(null===(o=t.ProductVolumes)||void 0===o?void 0:o.length)||(i=null==n?void 0:n.ProductVolumes);const a=null==i?void 0:i.find(t=>e.VolumeId&&t.VolumeId===e.VolumeId||e.VolumeDocumentId&&t.VolumeDocumentId===e.VolumeDocumentId||e.VolumeFerpCode&&t.VolumeFerpCode===e.VolumeFerpCode);a&&a.Price&&a.Price!=r&&(r=a.Price)}else!e||e.IsPromo||e.DocumentId||e.VolumeId||e.VolumeDocumentId||e.VolumeFerpCode||(e.ProductPrice=r=e.EditedPrice?e.EditedPrice:n.Price);return r}getDeliveryNetPrice(e,t){let r=0;return r=1==e.ValueType?t/(1+e.Value/100):t-e.Value,r}addProductTaxToOrderDetailTaxes(e){var t,r;if(e.TaxForAnotherTax||(e.TaxForAnotherTax=!1),e.taxAmount<0&&(e.taxAmount=0),e.orderDetail.OrderDetailTaxes||(e.orderDetail.OrderDetailTaxes=[]),e.productTaxe.Tax.IncludeOtherTaxes)null===(t=e.productTaxe.Tax.IncludedVATTaxes)||void 0===t||t.forEach(t=>{var r;let i=this.allTaxes.find(e=>t.Id&&e.Id==t.Id||t.DocumentId&&e.DocumentId==t.DocumentId);i||(i=t);let o={OrderDetailId:0,TaxId:i.Id,TaxDocumentId:i.DocumentId,TaxPercentage:t.Value,TaxValue:e.productPrice*(t.Value/100),ProductDocumentId:e.orderDetail.ProductDocumentId,ProductId:null!==(r=e.orderDetail.ProductId)&&void 0!==r?r:null,TaxForAnotherTax:e.TaxForAnotherTax},n=e.orderDetail.OrderDetailTaxes.findIndex(r=>e.TaxForAnotherTax==r.TaxForAnotherTax&&e.orderDetail.ProductDocumentId==r.ProductDocumentId&&(t.Id&&r.TaxId==t.Id||t.DocumentId&&r.TaxDocumentId==t.DocumentId));-1==n?e.orderDetail.OrderDetailTaxes.push(o):-1!=n&&(e.orderDetail.OrderDetailTaxes[n]=o)});else{let t={OrderDetailId:0,TaxId:e.productTaxe.Tax.Id,TaxDocumentId:e.productTaxe.Tax.DocumentId,TaxPercentage:e.productTaxe.Tax.Value,TaxValue:e.taxAmount,ProductDocumentId:e.orderDetail.ProductDocumentId,ProductId:null!==(r=e.orderDetail.ProductId)&&void 0!==r?r:null,TaxForAnotherTax:e.TaxForAnotherTax},i=e.orderDetail.OrderDetailTaxes.findIndex(t=>e.TaxForAnotherTax==t.TaxForAnotherTax&&e.orderDetail.ProductDocumentId==t.ProductDocumentId&&(e.productTaxe.Tax.Id&&t.TaxId==e.productTaxe.Tax.Id||e.productTaxe.Tax.DocumentId&&t.TaxDocumentId==e.productTaxe.Tax.DocumentId));-1==i?e.orderDetail.OrderDetailTaxes.push(t):-1!=i&&(e.orderDetail.OrderDetailTaxes[i]=t)}}addSubItemTaxToOrderDetailTaxes(e){var t,r;const i=e.subItem,o=e.productTax;if(e.TaxForAnotherTax||(e.TaxForAnotherTax=!1),e.orderDetail.OrderDetailTaxes||(e.orderDetail.OrderDetailTaxes=[]),o.Tax.IncludeOtherTaxes)null===(t=o.Tax.IncludedVATTaxes)||void 0===t||t.forEach(t=>{var r;let o=this.allTaxes.find(e=>t.Id&&e.Id==t.Id||t.DocumentId&&e.DocumentId==t.DocumentId);o||(o=t);let n={OrderDetailId:0,TaxId:o.Id,TaxDocumentId:o.DocumentId,TaxPercentage:t.Value,TaxValue:e.productPrice*(t.Value/100),ProductDocumentId:i.ProductSubItemDocumentId,ProductId:null!==(r=i.ProductSubItemId)&&void 0!==r?r:null,TaxForAnotherTax:e.TaxForAnotherTax},a=e.orderDetail.OrderDetailTaxes.findIndex(r=>e.TaxForAnotherTax==r.TaxForAnotherTax&&i.ProductSubItemDocumentId==r.ProductDocumentId&&(t.Id&&r.TaxId==t.Id||t.DocumentId&&r.TaxDocumentId==t.DocumentId));-1==a?e.orderDetail.OrderDetailTaxes.push(n):-1!=a&&(e.orderDetail.OrderDetailTaxes[a]=n)});else{let t={OrderDetailId:0,TaxId:o.Tax.Id,TaxDocumentId:o.Tax.DocumentId,TaxPercentage:o.Tax.Value,TaxValue:e.taxAmount,ProductDocumentId:i.ProductSubItemDocumentId,ProductId:null!==(r=i.ProductSubItemId)&&void 0!==r?r:null,TaxForAnotherTax:e.TaxForAnotherTax},n=e.orderDetail.OrderDetailTaxes.findIndex(t=>{var r;return e.TaxForAnotherTax==t.TaxForAnotherTax&&i.ProductSubItemDocumentId==t.ProductDocumentId&&((null===(r=o.Tax)||void 0===r?void 0:r.Id)&&t.TaxId==o.Tax.Id||o.Tax.DocumentId&&t.TaxDocumentId==o.Tax.DocumentId)});-1!=n?e.orderDetail.OrderDetailTaxes[n]=t:e.orderDetail.OrderDetailTaxes.push(t)}}addMinChargeTaxToOrderMasterTaxes(e,t){let r=e.OrderMasterTaxes.filter(e=>2==e.ServiceTaxType)[0];if(!this.minimumCharges||!this.minimumCharges.length)return;let i=this.minimumCharges[0].Tax[0];if(this.minimumCharges&&this.minimumCharges.length&&this.settingobj.UseMinimumCharge&&e.MinimumChargeDifferance>0&&t&&i&&(r?r.TaxAmount=e.MinimumChargeDifferance-e.MinimumChargeDifferance/(i.Value/100+1):e.OrderMasterTaxes.push({Id:t.Id+1,TaxId:i.Id,TaxDocumentId:i.DocumentId,TaxAmount:e.MinimumChargeDifferance-e.MinimumChargeDifferance/(i.Value/100+1),TaxPercentage:i.Value,DocumentId:t.DocumentId,IsDeleted:!1,IsSync:!1,OrderId:t.OrderId,ServiceTaxType:2})),t&&i&&r&&0==e.MinimumChargeDifferance){let t=e.OrderMasterTaxes.indexOf(r);e.OrderMasterTaxes.splice(t)}}addTaxToOrderMasterTaxes(e,t={}){var r,i,o,n,a;if(e.OrderMasterTaxes||(e.OrderMasterTaxes=[]),this.taxFound=e.OrderMasterTaxes.filter(e=>t.TaxId&&e.TaxId==t.TaxId||e.TaxDocumentId==t.TaxDocumentId)[0],this.settingobj.UseMinimumCharge&&1==e.HasMinimumCharge&&e.MinimumChargeDifferance>0&&(null===(r=this.minimumCharges)||void 0===r?void 0:r.length)&&(null===(o=null===(i=this.minimumCharges[0])||void 0===i?void 0:i.Tax)||void 0===o?void 0:o.length)&&(null===(a=null===(n=this.minimumCharges[0])||void 0===n?void 0:n.Tax[0])||void 0===a?void 0:a.DocumentId)&&(this.taxFound=this.allTaxes.filter(e=>e.DocumentId==this.minimumCharges[0].Tax[0].DocumentId)[0],this.addMinChargeTaxToOrderMasterTaxes(e,this.taxFound)),this.taxFound){let r=Number(t.TaxAmount),i=Number(t.TaxPercentage),o=e.OrderMasterTaxes.findIndex(e=>t.TaxId&&e.TaxId==t.TaxId||e.TaxDocumentId==t.TaxDocumentId);-1!=o&&(e.OrderMasterTaxes[o]={Id:this.taxFound.Id,TaxId:t.TaxId,TaxDocumentId:t.TaxDocumentId,TaxAmount:r,TaxPercentage:i,DocumentId:this.taxFound.DocumentId,IsDeleted:!1,IsSync:!1,OrderId:this.taxFound.OrderId,ServiceTaxType:this.taxFound.ServiceTaxType})}else e.OrderMasterTaxes.push({Id:0,TaxId:t.TaxId,TaxDocumentId:t.TaxDocumentId,TaxAmount:t.TaxAmount,TaxPercentage:t.TaxPercentage,DocumentId:"",IsDeleted:!1,IsSync:!1,OrderId:"",ServiceTaxType:t.ServiceTaxType})}handleWhenPriceIncludesTax(e,t,r=new a.a){let i=0;t.TaxPercentage=0,t.TaxAmount=0,t.TaxName="";let o={SideDishTaxAmount:0,SideDishNetPrice:0};this.calculateSideDishTaxAmount(t,o);let n=o.SideDishTaxAmount,s=o.SideDishNetPrice;return e.ProductTaxes.forEach(o=>{let a=0,u=0;a=o.Tax.Value,o.Tax&&(t.TaxName+="+ "+this.getTypeName(o.Tax)),t.TaxId=o.Tax.Id,t.TaxDocumentId=o.Tax.DocumentId,!r.IntegrationSystem||Number(r.IntegrationSystem)<1?(i=this.getNetPrice(e,null,t),t.ProductPrice=i):(i=t.RealPrice/(1+a/100),t.ProductPrice=i),!1===this.settingobj.CalculateTaxBeforeDiscount&&(0!==e.DiscountValue||t.DiscountPercentage>0||t.OrderDiscountValue>0)&&(i=i-Number(t.OrderDiscountValue)-Number(t.DiscountAmount)),u=a>0?i*(a/100):0,i&&o.Tax&&o.Tax.ExtraTax&&o.Tax.MinimumValue&&u<o.Tax.MinimumValue&&(t.TaxDifferenceValue=o.Tax.MinimumValue-u,u=o.Tax.MinimumValue),(100===r.Discount&&"1"===r.DiscountType||r.Discount===r.NetTotal&&"2"===r.DiscountType)&&(n=0,u=0,t.Product.TaxValue=0,t.SideDishTaxAmount=0,r.RemainigAmount=0),u<0&&(u=0),t.Product.TaxValue=u,t.SideDishTaxAmount=n,t.SideDishNetPrice=s,0===r.Discount&&(t.SideDishesValue=t.SideDishNetPrice+t.SideDishTaxAmount),this.addProductTaxToOrderDetailTaxes({product:e,orderDetail:t,taxAmount:u,productPrice:i,productTaxe:o}),u=this.calculateTaxHasVatTax(o,u,e,t),t.TaxAmount+=u,t.TaxPercentage+=a}),t}handleWhenPriceNotIncludesTax(e,t){t.TaxPercentage=0,t.TaxAmount=0,t.TaxName="";let r={SideDishTaxAmount:0,SideDishNetPrice:0};this.calculateSideDishTaxAmount(t,r);let i=r.SideDishTaxAmount,o=r.SideDishNetPrice;return e.ProductTaxes.forEach(r=>{let i=0,o=0;if(i+=r.Tax.Value,r.Tax&&(t.TaxName+="+ "+this.getTypeName(r.Tax)),t.TaxId=r.Tax.Id,t.TaxDocumentId=r.Tax.DocumentId,!1===this.settingobj.CalculateTaxBeforeDiscount&&(0!=t.DiscountPercentage||0!=e.DiscountValue||t.OrderDiscountValue>0)){let n=0;n=t.RealPrice-t.OrderDiscountValue-t.DiscountAmount,n<0&&(n=0),o=n*(i/100),o||(o=0),n&&r.Tax&&r.Tax.ExtraTax&&r.Tax.MinimumValue&&o<r.Tax.MinimumValue&&(t.TaxDifferenceValue=r.Tax.MinimumValue-o,o=r.Tax.MinimumValue),t.Product.TaxValue=o,n<=0&&(t.SideDishTaxAmount=0),this.addProductTaxToOrderDetailTaxes({product:e,orderDetail:t,taxAmount:o,productPrice:n,productTaxe:r})}else o=i>0?t.ProductPrice*(i/100):0,r.Tax&&r.Tax.ExtraTax&&r.Tax.MinimumValue&&o<r.Tax.MinimumValue&&(t.TaxDifferenceValue=r.Tax.MinimumValue-o,o=r.Tax.MinimumValue),this.addProductTaxToOrderDetailTaxes({product:e,orderDetail:t,taxAmount:o,productPrice:e.Price,productTaxe:r});o=this.calculateTaxHasVatTax(r,o,e,t),t.TaxAmount+=o,t.TaxPercentage+=i}),t.SideDishTaxAmount=i,t.SideDishNetPrice=o,t.SideDishesValue=t.SideDishNetPrice+t.SideDishTaxAmount,t}calculateTaxHasVatTax(e,t,r,i,o=!1){if(e.Tax&&e.Tax.HasVATTax&&e.Tax.VATTax){let n=this.allTaxes.find(t=>e.Tax.VATTax.Id&&t.Id==e.Tax.VATTax.Id||e.Tax.VATTax.DocumentId&&t.DocumentId==e.Tax.VATTax.DocumentId);n||(n=e.Tax.VATTax);const a=n.Value>0?t*(n.Value/100):0,s={Tax:n,TaxId:n.Id,TaxDocumentId:n.DocumentId,ProductId:r.Id,ProductDocumentId:r.DocumentId};o?this.addSubItemTaxToOrderDetailTaxes({orderDetail:i,subItem:r,productTax:s,taxAmount:a,productPrice:t,TaxForAnotherTax:!0}):this.addProductTaxToOrderDetailTaxes({product:r,orderDetail:i,taxAmount:a,productPrice:t,productTaxe:s,TaxForAnotherTax:!0}),t+=t*(e.Tax.VATTax.Value/100)}return t}getSubItemOriginalProduct(e){let t=e.productSubitem;return this.allproductlist&&this.allproductlist.length&&(t=this.allproductlist.find(t=>e.ProductSubItemId&&t.Id==e.ProductSubItemId||t.DocumentId==e.ProductSubItemDocumentId),e.productSubitem=this.deepCopy(t)),t}calculateSideDishTaxAmount(e,t){var r;(null===(r=null==e?void 0:e.OrderDetailSubItems)||void 0===r?void 0:r.length)>0&&e.OrderDetailSubItems.forEach(r=>{var i;let o=this.getSubItemOriginalProduct(r);r.TaxPercentage=0,r.TaxAmount=0,r.OrderDiscountValue||(r.OrderDiscountValue=0),r.RealPrice=r.Price;let n=this.getNetPrice(r,o);r.ProductPrice=n;let a=n;!1===this.settingobj.CalculateTaxBeforeDiscount&&(r.OrderDiscountValue>0||r.DiscountAmount>0)&&(a=a-r.OrderDiscountValue-r.DiscountAmount),null===(i=null==o?void 0:o.ProductTaxes)||void 0===i||i.forEach(t=>{r.Tax=t.Tax,r.TaxDocumentId=t.Tax.DocumentId,r.TaxId=t.Tax.Id,r.TaxPercentage+=r.Tax.Value;let i=r.Tax.Value>0?a*(r.Tax.Value/100):0;a&&t.Tax&&t.Tax.ExtraTax&&t.Tax.MinimumValue&&i<t.Tax.MinimumValue&&(r.TaxDifferenceValue=t.Tax.MinimumValue-i,i=t.Tax.MinimumValue),this.addSubItemTaxToOrderDetailTaxes({orderDetail:e,subItem:r,productTax:t,taxAmount:i,productPrice:n}),i=this.calculateTaxHasVatTax(t,i,r,e,!0),r.TaxAmount+=i}),r.ProductFinalPrice=n+r.TaxAmount,t.SideDishTaxAmount+=r.TaxAmount*r.Quantity,t.SideDishNetPrice+=n*r.Quantity})}handelProductDiscount(e,t,r){var i,o;e.DiscountValue||(e.DiscountValue=0),t.DiscountPercentage||(t.DiscountPercentage=0),r.Discount||(r.Discount=0),r.DiscountAmount||(r.DiscountAmount=0),t.ProductFinalPrice||(t.ProductFinalPrice=0),t.OrderDiscountValueToShow||(t.OrderDiscountValueToShow=0),t.SubItemDiscountValue=0,t.TotalSubItemDisountAmount=0,t.SideDishesValue&&"number"==typeof t.SideDishesValue||(t.SideDishesValue=0),t.DiscountAmount||(t.DiscountAmount=0),r.IntegrationSystem&&!(Number(r.IntegrationSystem)<1)||r.IsCallCenter||r.IsMobileOrder||(e.Price=this.getProductVolumePriceForDetail(t,e,e.Price),t.RealPrice=e.Price);let n=e.DiscountValue||t.DiscountPercentage,a=e.Price;this.settingobj.PriceIncludesTax&&(a=this.getNetPrice(e,null,t));let s=0;if(n&&(s=a*n/100),(0===t.DiscountAmount||e.AllowChangePrice)&&(t.DiscountAmount=s),n&&!r.DiscountType&&(r.DiscountType="1"),"1"==r.DiscountType)t.OrderDiscountValue=Number(r.Discount)/100*(a-s),(null===(i=null==t?void 0:t.OrderDetailSubItems)||void 0===i?void 0:i.length)>0&&t.OrderDetailSubItems.forEach(e=>{let i=this.getSubItemOriginalProduct(e),o=this.getNetPrice(e,i);e.DiscountAmount=Number(n)/100*o,e.OrderDiscountValue=Number(r.Discount)/100*(o-e.DiscountAmount),t.OrderDiscountValueToShow=e.OrderDiscountValue,t.SubItemDiscountValue+=e.OrderDiscountValue,t.TotalSubItemDisountAmount+=e.DiscountAmount}),t.OrderDiscountValueToShow=t.OrderDiscountValue;else if("2"==r.DiscountType){let e=0;r.OrderDetails.forEach(i=>{var o,n;i.Product||(i.Product=null===(o=this.allproductlist)||void 0===o?void 0:o.find(e=>e.DocumentId==i.ProductDocumentId));let a=null===(n=i.Product)||void 0===n?void 0:n.Price;this.settingobj.PriceIncludesTax?(r.Discount=i.Product.Tax?r.Discount/(1+i.Product.Tax.Value/100):r.Discount,a=this.getNetPrice(i.Product,null,t),i.TaxPercentage=i.Product.Tax?i.Product.Tax.Value:0,e+=i.SideDishesValue>0?(a+i.SideDishesValue/(1+i.TaxPercentage/100)-i.DiscountAmount)*i.ProductQuantity:(a-i.DiscountAmount)*i.ProductQuantity):e+=i.SideDishesValue>0?(a+i.SideDishesValue-i.DiscountAmount)*i.ProductQuantity:(a-i.DiscountAmount)*i.ProductQuantity});let i=r.Discount/e*100;t.OrderDiscountValue=i>0?i/100*(a-s):0,(null===(o=null==t?void 0:t.OrderDetailSubItems)||void 0===o?void 0:o.length)>0&&t.OrderDetailSubItems.forEach(e=>{let r=this.getSubItemOriginalProduct(e),o=this.getNetPrice(e,r);e.DiscountAmount=Number(n)/100*o,e.OrderDiscountValue=i>0?i/100*(o-e.DiscountAmount):0,t.OrderDiscountValueToShow=e.OrderDiscountValue,t.TotalSubItemDisountAmount+=e.DiscountAmount,t.SubItemDiscountValue+=e.OrderDiscountValue}),t.OrderDiscountValueToShow=t.OrderDiscountValue+t.SubItemDiscountValue}else t.OrderDiscountValue=0,t.OrderDiscountValueToShow=0,t.SubItemDiscountValue=0,t.OrderDetailSubItems&&t.OrderDetailSubItems.forEach(e=>e.OrderDiscountValue=0);return t.OrderDiscountValue&&t.OrderDiscountValueToShow||(t.OrderDiscountValue=0,t.OrderDiscountValueToShow=0),t}handelProductTax(e,t,r=new a.a){var i,o,n;if(t.TaxAmount||(t.TaxAmount=0),t.SideDishNetPrice||(t.SideDishNetPrice=0),t.SideDishTaxAmount||(t.SideDishTaxAmount=0),t.SubItemDiscountValue||(t.SubItemDiscountValue=0),e.ProductTaxes&&e.ProductTaxes.length)t.SideDishesValue&&"number"==typeof t.SideDishesValue||(t.SideDishesValue=0),t=this.settingobj.PriceIncludesTax||r.IsCallCenter&&(null===(i=this.pos)||void 0===i?void 0:i.LinkWithOnlineOrder)||r.IsMobileOrder?this.handleWhenPriceIncludesTax(e,t,r):this.handleWhenPriceNotIncludesTax(e,t);else if(!e.ProductTaxes||0==e.ProductTaxes.length){let i=0,n=0;if((null===(o=null==t?void 0:t.OrderDetailSubItems)||void 0===o?void 0:o.length)>0){t.OrderDetailSubItems.forEach(t=>{var r;void 0!==t.Tax&&void 0!==t.TaxDocumentId&&void 0!==t.TaxId&&void 0!==t.TaxPercentage&&void 0!==t.TaxAmount||(t.Tax=null==e?void 0:e.Tax,t.TaxDocumentId=null==e?void 0:e.TaxDocumentId,t.TaxId=null==e?void 0:e.TaxId,t.RealPrice=null==t?void 0:t.Price,t.ProductPrice=null==t?void 0:t.RealPrice,t.TaxAmount=(null==t?void 0:t.RealPrice)-(null==t?void 0:t.ProductPrice),t.TaxPercentage=null===(r=null==t?void 0:t.Tax)||void 0===r?void 0:r.Value)});for(let e=0;e<t.OrderDetailSubItems.length;e++)t.OrderDetailSubItems[e].TaxAmount<0&&(t.OrderDetailSubItems[e].TaxAmount=0),i+=t.OrderDetailSubItems[e].TaxAmount*t.OrderDetailSubItems[e].Quantity,n+=t.OrderDetailSubItems[e].ProductPrice*t.OrderDetailSubItems[e].Quantity}t.SideDishTaxAmount=i,t.SideDishNetPrice=n,t.SideDishesValue=t.SideDishNetPrice+t.SideDishTaxAmount,r.IntegrationSystem>0&&(t.ProductPrice=t.RealPrice)}return t.ProductFinalPrice||(t.ProductFinalPrice=0),t.ProductFinalPrice=t.ProductPrice-t.DiscountAmount-t.OrderDiscountValue+t.TaxAmount,t.ProductFinalPrice<0&&(t.ProductFinalPrice=0,t.SideDishTaxAmount=0,t.SideDishesValue=0),!t.ProductPrice&&(t.TaxAmount>0||(null===(n=t.OrderDetailTaxes)||void 0===n?void 0:n.length))&&(t.TaxAmount=0,t.OrderDetailTaxes=[]),t}handleServiceCharge(e){var t;let r=0,i=0,o=0,n=0,a=0;if(e.ServiceChargeValue||(e.ServiceChargeValue=0),100==e.Discount&&"1"==e.DiscountType||e.CancelServices)e.ServiceChargeValue=0,e.OrderMasterTaxes=[];else if(e.OrderType&&e.OrderType.Taxes&&e.OrderType.Taxes.length>0){e.OrderType.Taxes.forEach(t=>{var s;if(t.Tax){if(1==t.Tax.ValueType){let a=0;r+=t.Tax.Value;let u=e.NetTotal;(null===(s=this.settingobj)||void 0===s?void 0:s.IsServiceFromTotalWithVat)&&(u+=e.TotalTaxAmount),a=this.settingobj&&this.settingobj.IsServiceFromRealPrice?u*(t.Tax.Value/100):(u-Number(e.DiscountAmount)-Number(e.DetailsDiscount))*(t.Tax.Value/100),a<0&&(a=0),i+=a,o=a,n=t.Tax.Value}else if(2==t.Tax.ValueType){let a=t.Tax.Value;t.Tax.ForOnePerson&&e.PersonsCount&&(a=e.SubTotal?t.Tax.Value*e.PersonsCount:0),i+=a;let s=0;s=this.settingobj&&this.settingobj.IsServiceFromRealPrice?a/e.NetTotal*100:a/(e.NetTotal-Number(e.DiscountAmount)-Number(e.DetailsDiscount))*100,r+=s,n=s,o=a}let u=this.allTaxes.find(e=>t.Tax.Id&&e.Id==t.Tax.Id||t.Tax.DocumentId&&e.DocumentId==t.Tax.DocumentId);if(u||(u=t.Tax),this.addTaxToOrderMasterTaxes(e,{TaxId:u.Id,TaxDocumentId:u.DocumentId,TaxAmount:o,TaxPercentage:n,Tax:u,ServiceTaxType:3}),t.Tax.IncludedVATTaxes&&t.Tax.IncludedVATTaxes.length>0&&!t.Tax.VATTax&&(t.Tax.VATTax=t.Tax.IncludedVATTaxes[0],t.Tax.HasVATTax=!0,t.Tax.VATTaxDocumentId=t.Tax.VATTax.DocumentId,t.Tax.VATTaxId=t.Tax.VATTax.Id),t.Tax.HasVATTax&&t.Tax.VATTax)if(a+=o*(t.Tax.VATTax.Value/100),t.Tax.VATTax.IncludeOtherTaxes&&t.Tax.VATTax.IncludedVATTaxes)t.Tax.VATTax.IncludedVATTaxes.forEach(t=>{let r=this.allTaxes.find(e=>t.Id&&e.Id==t.Id||t.DocumentId&&e.DocumentId==t.DocumentId);r||(r=t),this.addTaxToOrderMasterTaxes(e,{TaxId:r.Id,TaxDocumentId:r.DocumentId,TaxAmount:o*(t.Value/100),TaxPercentage:r.Value,Tax:r,ServiceTaxType:3})});else{let r=this.allTaxes.find(e=>t.Tax.VATTaxId&&e.Id==t.Tax.VATTaxId||t.Tax.VATTaxDocumentId&&e.DocumentId==t.Tax.VATTaxDocumentId);r||(r=t.Tax.VATTax),this.addTaxToOrderMasterTaxes(e,{TaxId:r.Id,TaxDocumentId:r.DocumentId,TaxAmount:a,TaxPercentage:r.Value,Tax:r,ServiceTaxType:3})}}});let s=null===(t=e.OrderMasterTaxes)||void 0===t?void 0:t.filter(e=>!e.TaxId&&!e.TaxDocumentId);s&&s.length>0&&s.forEach(t=>{let r=e.OrderMasterTaxes.indexOf(t);-1!=r&&e.OrderMasterTaxes.splice(r,1)})}else e.OrderMasterTaxes=[];e.ChannelName?e.ServiceChargePercentage=null!=e.ServiceChargeValue?e.ServiceChargeValue/e.SubTotal:0:(e.ServiceChargeValue=i,e.ServiceChargePercentage=r),e.ServiceChargeValue>0&&e.OrderDetails&&e.OrderDetails.length>0?e.OrderDetails.forEach(t=>{if(this.settingobj&&this.settingobj.IsServiceFromRealPrice)t.ServiceChargeValue=Number(e.ServiceChargePercentage)/100*t.ProductPrice,a>0&&(t.ServiceChargeValue+=a*(t.ProductPrice/e.NetTotal));else if(t.ServiceChargeValue=Number(e.ServiceChargePercentage)/100*(t.ProductPrice-t.DiscountAmount-t.OrderDiscountValue),a>0){let r=(t.ProductPrice-t.DiscountAmount-t.OrderDiscountValue)/(e.NetTotal-Number(e.DiscountAmount)-Number(e.DetailsDiscount));t.ServiceChargeValue+=a*r}}):0==e.ServiceChargeValue&&e.OrderDetails&&e.OrderDetails.length>0&&e.OrderDetails.forEach(e=>{e.ServiceChargeValue=0}),e.TotalTaxAmount+=a,e.SubTotal+=e.ServiceChargeValue+a}handleDeliveryTax(e){var t;if(e.TotalTaxAmount||(e.TotalTaxAmount=0),e.DeliveryNetPrice=0,e.DeliveryPrice>0&&this.settingobj&&this.settingobj.ApplyTaxOnDeliveryPrice&&this.settingobj.TaxDocumentId){let r=this.allTaxes.filter(e=>e.DocumentId==this.settingobj.TaxDocumentId)[0];if(r){let i=0,o=0;if(this.settingobj.PriceIncludesTax){if(1==r.ValueType){let t=this.getDeliveryNetPrice(r,e.DeliveryPrice);e.DeliveryNetPrice=t,i=t*r.Value/100,o=r.Value}else if(2==r.ValueType){let t=this.getDeliveryNetPrice(r,e.DeliveryPrice);e.DeliveryNetPrice=t,i=r.Value,o=r.Value/t*100}}else 1==r.ValueType?(i=e.DeliveryPrice*r.Value/100,o=r.Value):2==r.ValueType&&(i=r.Value,o=r.Value/e.DeliveryPrice*100),e.SubTotal+=i;this.addTaxToOrderMasterTaxes(e,{TaxId:r.Id,TaxDocumentId:r.DocumentId,TaxAmount:i,TaxPercentage:o,Tax:r,ServiceTaxType:1});let n=null===(t=e.OrderMasterTaxes)||void 0===t?void 0:t.filter(e=>!e.TaxId&&!e.TaxDocumentId);n&&n.length>0&&n.forEach(t=>{let r=e.OrderMasterTaxes.indexOf(t);-1!=r&&e.OrderMasterTaxes.splice(r,1)}),e.TotalTaxAmount+=i}}}handlePromo(e,t,r){var i,o,n,a,s,u,d,l,c;if(this.refreshDateAndTime(),e.Promos&&e.Promos.length>0){let m=e.Promos.filter(e=>this.chekWithinTime(e));const h=(null==t?void 0:t.VolumeDocumentId)||e.VolumeDocumentId;h&&(m=m.filter(t=>t.PromoProducts.some(t=>t.TakeProductVolumeDocumentId==h&&t.TakeProductDocumentId==e.DocumentId))),e.Promos=[],e.ShowDiscount=!1,m.length&&e.Promos.push(...m);const T=null!==(o=null===(i=null==r?void 0:r.OrderPayments)||void 0===i?void 0:i.flatMap(e=>e.PayTypeDocumentId))&&void 0!==o?o:[];m=m.filter(e=>{var t;return!(null===(t=e.OrderPayTypesList)||void 0===t?void 0:t.length)||(null==T?void 0:T.length)&&(null==T?void 0:T.every(t=>e.OrderPayTypesList.includes(t)))});const D=(null===(n=null==r?void 0:r.OrderType)||void 0===n?void 0:n.DocumentId)||(null===(s=null===(a=this.orderobj)||void 0===a?void 0:a.OrderType)||void 0===s?void 0:s.DocumentId)||(null===(u=this.pointOfSale)||void 0===u?void 0:u.OrderTypeId)||(null===(d=null==r?void 0:r.pointOfSale)||void 0===d?void 0:d.OrderTypeId)||(null===(c=null===(l=this.orderobj)||void 0===l?void 0:l.pointOfSale)||void 0===c?void 0:c.OrderTypeId);m=m.filter(e=>{var t;return!D||!(null===(t=e.OrderTypesList)||void 0===t?void 0:t.length)||e.OrderTypesList.find(e=>D==e)});const P=m[0];P?1!=P.ValueType&&5!=P.ValueType||(e.ShowDiscount=!0,1==P.ValueType&&(e.DiscountValue=P.Value)):P||!t||(null==t?void 0:t.IsPromo)||(e.DiscountValue=0,t.DiscountAmount=0,t.DiscountPercentage=0)}return t}assignPromoCustomPrice(e,t=null){var r,i,o,n,a,s,u;const d=(null===(r=e.Promos)||void 0===r?void 0:r.length)?e.Promos[0]:void 0;if(d&&(!(null===(i=null==d?void 0:d.OrderTypesList)||void 0===i?void 0:i.length)||d.OrderTypesList.find(e=>{var t;return e==(null===(t=this.orderobj)||void 0===t?void 0:t.OrderType.DocumentId)})&&(null===(n=null===(o=this.orderobj)||void 0===o?void 0:o.OrderType)||void 0===n?void 0:n.IsPromo))&&(null===(a=e.Promos)||void 0===a?void 0:a.length)&&e.Promos.some(e=>5==e.ValueType)){let r=null===(u=null===(s=e.Promos.find(e=>5==e.ValueType))||void 0===s?void 0:s.PromoProducts)||void 0===u?void 0:u.filter(t=>t.TakeProductDocumentId==e.DocumentId);(null==r?void 0:r.length)&&(null==t?void 0:t.length)>0&&t.forEach(e=>{var t;const i=null===(t=this.volumes)||void 0===t?void 0:t.find(t=>e.VolumeDocumentId&&e.VolumeDocumentId==t.DocumentId||e.VolumeId&&e.VolumeId==t.Id),o=r.find(e=>e.TakeProductVolumeDocumentId==(null==i?void 0:i.DocumentId));o&&(e.Price=o.CustomPrice)}),(null==r?void 0:r.length)&&e.VolumeDocumentId&&(r=r.filter(t=>t.TakeProductVolumeDocumentId==e.VolumeDocumentId&&t.TakeProductDocumentId==e.DocumentId)),(null==r?void 0:r.length)&&(e.Price=r[0].CustomPrice)}}oldchekWithinTime(e){const t=this.getTimeString(new Date(e.FromTime)),r=this.getTimeString(new Date(e.ToTime)),i=this.getOnlyDate(new Date(e.FromDate)),o=this.getOnlyDate(new Date(e.ToDate));return this.isWeekDayIncluded(e.WorkDays,this.currentMachineDay)&&t<=this.currentMachineTime&&r>=this.currentMachineTime&&i<=this.currentMachineDate&&o>=this.currentMachineDate}chekWithinTime(e){const t=this.getTimeString(new Date(e.FromTime)),r=this.getTimeString(new Date(e.ToTime)),i=this.getOnlyDate(new Date(e.FromDate)),o=this.getOnlyDate(new Date(e.ToDate)),n=this.currentMachineDayTime,a=new Date(`${Object(v.f)(i)}T${t}`);let s=new Date(`${Object(v.f)(o)}T${r}`);return s<=a&&(s.setDate(s.getDate()+1),o.setDate(o.getDate()+1)),this.isWeekDayIncluded(e.WorkDays,this.currentMachineDay)&&n>=a&&n<=s&&this.currentMachineDate>=i&&this.currentMachineDate<=o}handelCustomerPromos(e,t){var r;if(this.refreshDateAndTime(),this.customerPromos&&this.customerPromos.length&&e.CustomerDocumentId){let t,i=this.customerPromos.filter(t=>t.CustomersList&&t.CustomersList.includes(e.CustomerDocumentId)&&this.chekWithinTime(t))[0];i&&i.ValueType&&i.Value&&(t=null===(r=i.OrderTypesList)||void 0===r?void 0:r.find(t=>t===e.OrderTypeDocumentId),i.IsAppliedToProducts?i.IsAppliedToProducts&&e.OrderDetails.forEach(e=>{for(let t=0;t<i.ProductList.length;t++)i.ProductList[t]===e.ProductDocumentId&&(e.DiscountPercentage=i.Value)}):(e.DiscountType=i.ValueType,e.Discount=i.Value))}}handelMinimumCharge(e,t){var r,i,o,n,a,s;if(this.refreshDateAndTime(),this.minimumCharges&&this.minimumCharges.length&&this.settingobj.UseMinimumCharge&&t.PersonsCount&&t.TableId){const u=null!==(r=null==e?void 0:e.DocumentId)&&void 0!==r?r:t.TableId;let d=null===(o=null===(i=this.minimumCharges[0])||void 0===i?void 0:i.Tables)||void 0===o?void 0:o.filter(e=>e.DocumentId==u)[0];d&&this.isWeekDayIncluded(null===(n=this.minimumCharges[0])||void 0===n?void 0:n.WorkDays,this.currentMachineDay)&&this.getTimeString(new Date(null===(a=this.minimumCharges[0])||void 0===a?void 0:a.TimeFrom))<=this.currentMachineTime&&this.getTimeString(new Date(null===(s=this.minimumCharges[0])||void 0===s?void 0:s.TimeTo))>=this.currentMachineTime&&d&&d.ValuePerPerson&&d.OrderTypesList&&t.PersonsCount&&(this.orderobj.MinimumChargeValue=t.MinimumChargeNewPerPerson?t.PersonsCount*t.MinimumChargeNewPerPerson:t.PersonsCount*d.ValuePerPerson)}}calculateOrderDetailTotal(e,t=new a.a){let r=0;return e.TaxAmount||(e.TaxAmount=0),e.DiscountAmount||(e.DiscountAmount=0),e.OrderDiscountValue||(e.OrderDiscountValue=0),e.OrderDiscountValueToShow||(e.OrderDiscountValueToShow=0),r=(e.ProductPrice+e.TaxAmount-e.DiscountAmount-e.OrderDiscountValue-e.SubItemDiscountValue-e.TotalSubItemDisountAmount)*e.ProductQuantity,null!=e.SideDishNetPrice&&(r+=e.SideDishNetPrice+e.SideDishTaxAmount),r<0&&(r=0),r}calculateTotals(e,t){if(e.NetTotal=0,e.TotalInsuranceAmount=0,e.DetailsDiscount=0,e.TotalTaxAmount=0,e.DiscountAmount||(e.DiscountAmount=0),e.Discount||(e.Discount=0),e.ServiceChargeValue||(e.ServiceChargeValue=0),e.DeliveryPrice=e.DeliveryPrice?Number(e.DeliveryPrice):0,e.DeliveryPersonDeliveryPrice=e.DeliveryPersonDeliveryPrice?Number(e.DeliveryPersonDeliveryPrice):0,e.OrderInsurance&&e.OrderInsurance.OrderInsuranceDetails&&e.OrderInsurance.OrderInsuranceDetails.length>0){const t=e.OrderInsurance.OrderInsuranceDetails.reduce((e,t)=>e+Number(t.Quantity)*Number(t.Price),0);e.TotalInsuranceAmount=t||0}if(0!=e.OrderDetails.length||null!=e.OrderDetails){if(e.OrderDetails.forEach(t=>{let r=0;t.SideDishNetPrice&&"number"==typeof t.SideDishNetPrice&&(r=t.SideDishNetPrice),e.NetTotal+=t.ProductPrice*t.ProductQuantity+r,t.InsuranceValue||(t.InsuranceValue=0),t.DiscountAmount||(t.DiscountAmount=0),t.TaxAmount||(t.TaxAmount=0),t.TotalSubItemDisountAmount||(t.TotalSubItemDisountAmount=0),e.DetailsDiscount+=(t.DiscountAmount+t.TotalSubItemDisountAmount)*t.ProductQuantity,e.TotalTaxAmount+=t.SideDishTaxAmount?t.TaxAmount*t.ProductQuantity+t.SideDishTaxAmount:t.TaxAmount*t.ProductQuantity}),"1"==e.DiscountType)e.DiscountAmount=Number(e.Discount)/100*(e.NetTotal-e.DetailsDiscount),100==e.Discount&&(e.DeliveryPrice=0,e.DeliveryPersonDeliveryPrice=0,e.TotalTaxAmount=0);else if("2"==e.DiscountType&&e.NetTotal>0){let t=Number(e.Discount)/(e.NetTotal-e.DetailsDiscount)*100;e.DiscountAmount=t/100*(e.NetTotal-e.DetailsDiscount)}e.Total=e.NetTotal-e.DetailsDiscount-e.DiscountAmount+e.TotalTaxAmount,e.Total<0&&(e.Total=0),e.SubTotal=e.NetTotal-e.DetailsDiscount-e.DiscountAmount+e.TotalTaxAmount+Number(e.DeliveryPrice),e.SubTotal<=0&&(e.SubTotal=0,e.RemainigAmount=0),e=this.handelDriverSettings(e),this.handleServiceCharge(e),this.handleDeliveryTax(e),this.handleRoundingFraction(e),this.calculateOrderPayments(e,t),localStorage.setItem("orderobj",JSON.stringify(e))}}recalculateSideDishesValue(e){e.SideDishesValue=0,e.OrderDetailSubItems&&e.OrderDetailSubItems.length>0&&e.OrderDetailSubItems.forEach(t=>{const r=this.deepCopy(this.orderSer.originalProductList.find(e=>t.ProductSubItemId&&e.Id==t.ProductSubItemId||t.ProductSubItemDocumentId&&e.DocumentId==t.ProductSubItemDocumentId));let i=e.ProductQuantity;i||(i=0),t.Price||(t.Price=0),(null==r?void 0:r.UseWeights)||i%1==0||(i=i<1?1:Math.floor(i)),t.Quantity=Number(i)*Number(t.SingleQuantity),e.SideDishesValue+=t.Quantity*Number(t.Price)})}handleRoundingFraction(e){if(this.settingobj&&this.settingobj.RoundingMethod>0&&this.settingobj.RoundingLevel>0){let t,r=e.SubTotal;switch(this.settingobj.RoundingLevel){case.01:e.SubTotal=Number((this.getRoundedNumber(100*e.SubTotal)/100).toFixed(2));break;case.25:e.SubTotal=Number((this.getRoundedNumber(4*e.SubTotal)/4).toFixed(2));break;case.05:e.SubTotal=Number((this.getRoundedNumber(20*e.SubTotal)/20).toFixed(2));break;case.1:t=Math.pow(10,1),e.SubTotal=this.getRoundedNumber(e.SubTotal*t)/t;break;case.5:e.SubTotal=Number((this.getRoundedNumber(2*e.SubTotal)/2).toFixed(1));break;case 1:t=Math.pow(10,0),e.SubTotal=this.getRoundedNumber(e.SubTotal*t)/t;break;case 5:e.SubTotal=5*this.getRoundedNumber(e.SubTotal/5);break;case 10:e.SubTotal=10*this.getRoundedNumber(e.SubTotal/10)}e.RoundingFraction=e.SubTotal-r}}getRoundedNumber(e){switch(this.settingobj.RoundingMethod){case 1:e=Math.ceil(e);break;case 2:e=Math.floor(e);break;case 3:e=Math.round(e)}return e}checkCallCenter(e){var t;return(null==e?void 0:e.pointOfSale)&&(null===(t=null==e?void 0:e.pointOfSale)||void 0===t?void 0:t.IsCallCenter)&&(e.IsCallCenter=!0,e&&e.CustomerDocumentId&&e.CustomerAddressDocumentId?e.CallCenterBranch||$("#modal-Branches").modal("show"):(this.isDelivery=!0,$("#modal-40444").modal("show"))),e}setCallCenterBranch(e,t){return e.CallCenterBranch=t.DocumentId,$("#modal-Branches").modal("hide"),e}setProductPriceForMobileOrder(e,t){if(t||0===t){e.EditedPrice=Number(t),e.ProductPrice=Number(t),e.Product.Price=Number(t),e.Product.PriceChanged=!0;let r=this.allproductlist.find(t=>t.DocumentId==e.ProductDocumentId);r&&(r.PriceChanged=!0,r.Price=Number(t))}}setProductQuantityForGame(e){var t,r,i;if(!e.TableId||!(null===(t=this.halls)||void 0===t?void 0:t.length))return;const o=null===(r=this.halls)||void 0===r?void 0:r.find(t=>t.Tables.some(t=>t.DocumentId===e.TableId));o&&(null==o?void 0:o.ServeEntertainmentServices)&&(null===(i=e.OrderDetails)||void 0===i||i.forEach(e=>{if(e.StartTime&&e.EndTime){const t=Object(v.g)(e.StartTime,e.EndTime)/60;if(2!=(null==o?void 0:o.EntertainmentServiceTime))e.ProductQuantity=Math.ceil(t)/60;else{const r=15*Math.ceil(t/15);e.ProductQuantity=r/60}}e.TotalTime=this.getGameTime(e)}))}getGameTime(e){if(e.StartTime&&e.EndTime){const t=Object(v.g)(e.StartTime,e.EndTime)/60;return`${Math.floor(t/60)}H / ${Math.ceil(t%60)}M`}return""}tableHasMinCharge(e){var t,r,i,o,n,a,s;const u=null===(r=null===(t=this.minimumCharges[0])||void 0===t?void 0:t.Tables)||void 0===r?void 0:r.find(t=>t.DocumentId===e.TableId);if(u){const t=(null===(i=u.OrderTypesList)||void 0===i?void 0:i.length)?!(!(null===(o=u.OrderTypesList)||void 0===o?void 0:o.includes(e.OrderTypeDocumentId))||!u.ValuePerPerson):!!u.ValuePerPerson;return 4==(null===(n=e.OrderType)||void 0===n?void 0:n.Value)&&(null===(s=null===(a=this.orderSer)||void 0===a?void 0:a.settings)||void 0===s?void 0:s.UseMinimumCharge)&&e.MinimumChargeValue&&e.TableId&&t}return!1}ApplySubTotalWithMinChargeValue(e){var t,r,i,o,n,a,s,u,d,l,c;(null===(t=e.OrderMasterTaxes)||void 0===t?void 0:t.length)||(e.OrderMasterTaxes=[]),e.SubTotal<e.MinimumChargeValue&&this.tableHasMinCharge(e)?1==e.HasMinimumCharge&&(e.MinimumChargeDifferance=e.MinimumChargeValue-e.SubTotal,e.MinimumChargeDifferance>0&&(null===(r=this.minimumCharges)||void 0===r?void 0:r.length)&&(null===(o=null===(i=this.minimumCharges[0])||void 0===i?void 0:i.Tax)||void 0===o?void 0:o.length)&&(null===(a=null===(n=this.minimumCharges[0])||void 0===n?void 0:n.Tax[0])||void 0===a?void 0:a.DocumentId)&&this.addTaxToOrderMasterTaxes(e),e.SubTotal=e.MinimumChargeValue,(null===(s=this.minimumCharges)||void 0===s?void 0:s.length)&&(null===(d=null===(u=this.minimumCharges[0])||void 0===u?void 0:u.Tax)||void 0===d?void 0:d.length)&&(null===(c=null===(l=this.minimumCharges[0])||void 0===l?void 0:l.Tax[0])||void 0===c?void 0:c.DocumentId)&&(e.minChargeTaxValue=e.OrderMasterTaxes.filter(e=>2==e.ServiceTaxType)[0].TaxAmount),e.minChargeTaxValue&&(e.MinimumChargeDifferance=e.MinimumChargeDifferance-e.minChargeTaxValue),e.RemainigAmount=-1*e.MinimumChargeValue,e.OrderPayments[0].Amount=e.MinimumChargeValue):(e.SubTotal>e.MinimumChargeValue||!this.tableHasMinCharge(e))&&(e.MinimumChargeDifferance=0,e.minChargeTaxValue=0,e.HasMinimumCharge=!1,e.OrderMasterTaxes=e.OrderMasterTaxes.filter(e=>2!=e.ServiceTaxType))}recalculateOrderObject(e,t=!0,r=!1,i=!1){if(this.checkWorkTimeFinished(),e.Serial||(e.Serial=I.Guid.create().toString()),e&&e.OrderDetails){this.handelCustomerPromos(e,!1),e.OrderDetails.filter(e=>!e.IsCancelled);for(let t=e.OrderDetails.length-1;t>=0;t--){e.IsDeliverectOrder&&this.setProductPriceForMobileOrder(e.OrderDetails[t],e.OrderDetails[t].RealPrice);let r=e.OrderDetails[t].Product;e.OrderDetails[t].UUID||(e.OrderDetails[t].UUID=I.Guid.create().toString()),r&&(this.recalculateSideDishesValue(e.OrderDetails[t]),this.checkProductVolumeAndSides(e.OrderDetails[t]),e.OrderDetails[t]=this.handlePromo(r,e.OrderDetails[t],e),e.OrderDetails[t]=this.handelProductDiscount(r,e.OrderDetails[t],e),e.OrderDetails[t]=this.handelProductTax(r,e.OrderDetails[t],e),this.setProductGroup(e.OrderDetails[t])),e.OrderDetails[t].Total=this.calculateOrderDetailTotal(e.OrderDetails[t],e)}this.handleDeliveryPriceOptions(e,!0),this.calculateTotals(e,t),this.ApplySubTotalWithMinChargeValue(e),e=this.getReportTranslationObj(e),this.updatePendingOrders(e)}return e=this.checkCallCenter(e),this.settingobj.IsUsingCustomerPriceDisplay&&(e.DispalyMode=2,this.orderSer.VFDDisplay(e).subscribe()),this.calculateRemainingAmount(e),this.handelFoodPlan(e,i),r?e:this.setOrderTypeDiscountValue(e)}setOrderTypeDiscountValue(e){var t,r,i;if(2==(null===(t=e.OrderType)||void 0===t?void 0:t.DiscountType)&&(null===(r=e.OrderType)||void 0===r?void 0:r.Discount)>0){const t=null===(i=e.OrderType)||void 0===i?void 0:i.Discount;return e.Discount=e.DiscountVal=e.DiscountPer=0,this.calculateTotals(e,!1),e.DiscountPer=e.SubTotal>0?Number(t)/e.SubTotal*100:0,e.DiscountPer=e.DiscountPer>100?100:e.DiscountPer,e.Discount=e.DiscountPer,e.DiscountType="1",this.recalculateOrderObject(e,!0,!0)}return e}addCustomPromoWithOrderDetail(){}handelFoodPlan(e,t=!1){var r;e.EmployeeDocumentId&&e.FoodPlanData&&!t&&(null===(r=e.FoodPlanData)||void 0===r?void 0:r.remainingAmount)&&(e.Discount=e.DiscountVal=e.DiscountPer=0,(e=this.recalculateOrderObject(e,!0,!1,!0)).Discount=e.NetTotal?e.FoodPlanData.remainingAmount/e.NetTotal*100:0,e.Discount=this.clamp(e.Discount,0,100),e.DiscountType="1",(e=this.recalculateOrderObject(e,!0,!1,!0)).FoodPlanDiscountAmount=e.DiscountAmount)}setProductGroup(e){if(this.productgrouplist&&this.productgrouplist.length){const t=this.productgrouplist.find(t=>e.ProductGroupDocumentId&&t.DocumentId===e.ProductGroupDocumentId||e.ProductGroupId&&t.Id===e.ProductGroupId);t&&(e.ProductGroupId=t.Id,e.ProductGroupDocumentId=t.DocumentId,e.ProductGroupName=t.Name)}}handleDeliveryPriceOptions(e,t){var r,i,o,n;let a=!1;if(e.OrderType&&2==e.OrderType.Value)if(t){if(this.settingobj.IsDeliveryFreeForAll?(e.DeliveryPrice=0,e.DeliveryPersonDeliveryPrice=0):this.settingobj.IsDeliveryFixed?(e.DeliveryPrice=this.settingobj.FixedDeliveryPrice,e.DeliveryPersonDeliveryPrice=0):this.settingobj.IsDeliveryFreeForBigOrders&&e.SubTotal>=this.settingobj.BigOrdersSubTotal&&(e.DeliveryPrice=0,e.DeliveryPersonDeliveryPrice=0),(null===(r=this.settingobj)||void 0===r?void 0:r.IsDeliveryIncludedInRevenueAsPercentage)&&(null===(i=this.settingobj)||void 0===i?void 0:i.DeliveryIncludedPercentage)){const t=document.activeElement;if(!(null==t?void 0:t.name)||"RegionsDeliveryPrice"!=(null==t?void 0:t.name)){const t=(null!==(o=e.DeliveryPrice)&&void 0!==o?o:0)+(null!==(n=e.DeliveryPersonDeliveryPrice)&&void 0!==n?n:0);e.DeliveryPrice=t*(this.clamp(this.settingobj.DeliveryIncludedPercentage,1,100)/100),e.DeliveryPersonDeliveryPrice=t-e.DeliveryPrice}}}else this.settingobj.DeliveryMaxSubTotal&&0!=Number(this.settingobj.DeliveryMaxSubTotal)&&(e.SubTotal>=this.settingobj.DeliveryMinSubTotal&&e.SubTotal<=this.settingobj.DeliveryMaxSubTotal||(a=!0));return a}calculateOrderPayments(e,t){const r=this.deepCopy(e.OrderPayments);if(!e.Reservation&&1===(null==r?void 0:r.length)&&r[0].Amount===this.totalForAllPay(e))return e;if(e.OrderPayments&&!t||(e.OrderPayments=[]),t||0==e.OrderPayments.length)if(e.FreePaymentCalculated&&r[0]&&r[0].PayTypeDocumentId){let t=this.orderPayTypelist.filter(e=>e.DocumentId==r[0].PayTypeDocumentId)[0];this.setOrderPayType(t||this.orderPayTypelist[0],e)}else if(e.OrderType&&(e.OrderType.OrderPayTypeDocumentId||e.OrderType.OrderPayTypeId)){let t=this.orderPayTypelist.filter(t=>e.OrderType.OrderPayTypeId&&t.Id==e.OrderType.OrderPayTypeId||e.OrderType.OrderPayTypeDocumentId&&t.DocumentId==e.OrderType.OrderPayTypeDocumentId)[0];this.setOrderPayType(t||this.orderPayTypelist[0],e)}else if(e.OrderType&&4==e.OrderType.Value&&e.OrderType.ForStaff){let t=this.orderPayTypelist.filter(e=>20==e.PayType)[0];this.setOrderPayType(t||this.orderPayTypelist[0],e)}else if(e.Reservation&&e.PayedAmountReservation>e.SubTotal){let t=this.orderPayTypelist.filter(e=>20==e.PayType)[0];this.setOrderPayType(t||this.orderPayTypelist[0],e)}else{const t=1===(null==r?void 0:r.length)?this.orderPayTypelist.find(e=>e.DocumentId==r[0].PayTypeDocumentId&&70!=e.PayType):this.orderPayTypelist[0];this.setOrderPayType(null!=t?t:this.orderPayTypelist[0],e)}return e}setReservationPayment(e){if(e.Reservation&&e.PayedAmountReservation>0){let t=this.orderPayTypelist.filter(e=>20==e.PayType)[0];if(t){let r=new d.a;r.PayTypeId=t.Id,r.PayTypeDocumentId=t.DocumentId,r.PayTypeName=t.Name,r.Amount=e.PayedAmountReservation,r.PayAmount=e.PayedAmountReservation,r.ReservationPayment=!0,(null==e.OrderPayments||0==e.OrderPayments.length||-1==e.OrderPayments.findIndex(e=>r.PayTypeId&&e.PayTypeId==r.PayTypeId||e.PayTypeDocumentId==r.PayTypeDocumentId)&&0!=e.OrderPayments[e.OrderPayments.length-1].Amount)&&(e.OrderPayments.push(r),this.calculateRemainingAmount(e))}else this.toastr.info("Missing Credit Payment Types !"),this.router.navigateByUrl("/PayType")}return e}setOrderPayType(e,t,r=null){var i,o,n;if(t.OrderPayments||(t.OrderPayments=[]),t.IntegrationSystem&&t.IntegrationSystem>0)return;t.Reservation&&t.PayedAmountReservation>0&&(t=this.setReservationPayment(t)),e||(e=new u.a),t.TotalInsuranceAmount||(t.TotalInsuranceAmount=0);let a=new d.a;if(a.PayTypeId=e.Id?e.Id:null,a.PayTypeDocumentId=e.DocumentId,t.OrderPayTypeId=e.Id?e.Id:null,t.OrderPayTypeDocumentId=e.DocumentId,t.OrderPayTypeName=e.Name,a.PayTypeName=this.getTypeName(e),70==e.PayType&&(a.PayType=e.PayType),70===e.PayType&&t.RemainigAmount<0){let e=Math.abs(t.RemainigAmount)>(null===(i=this.selectedPointsCard)||void 0===i?void 0:i.Value)?null===(o=this.selectedPointsCard)||void 0===o?void 0:o.Value:Math.abs(t.RemainigAmount);e&&Object(v.d)(e)>5&&(e=parseFloat(e.toFixed(5))),a.Amount=e,a.PayAmount=e,t.PointsCountApplied=null===(n=this.selectedPointsCard)||void 0===n?void 0:n.PointsCount}else a.Amount=0;r&&(a.PayTypeName=r.Name,a.PaymentSystemDocumentId=r.PaymentSystemDocumentId),70!==e.PayType&&(a.Amount=null==t.OrderPayments||0==t.OrderPayments.length?t.SubTotal+t.DeliveryPersonDeliveryPrice+t.TotalInsuranceAmount:Number(t.RemainigAmount)>=0?0:-1*t.RemainigAmount),(!t.Reservation||t.PayedAmountReservation<t.SubTotal)&&(null==t.OrderPayments||0==t.OrderPayments.length||-1==t.OrderPayments.findIndex(e=>e.PayTypeDocumentId==a.PayTypeDocumentId)&&0!=t.OrderPayments[t.OrderPayments.length-1].Amount)&&(70===a.PayType?(t.OrderPayments.unshift(a),this.calculateRemainingAmount(t,Object(v.d)(t.SubTotal)>5),t.RemainigAmount<0&&this.setOrderPayType(this.defaultSelectedPayType,t)):t.OrderPayments.push(a),this.calculateRemainingAmount(t)),e.Percentage>0&&!t.FreePaymentCalculated?(t.Discount=e.Percentage,t.DiscountType="1",t.FreePaymentCalculated=!0,t=this.recalculateOrderObject(t,!0)):t.FreePaymentCalculated&&(t.FreePaymentCalculated=!1)}calculateRemainingAmount(e=new a.a,t=!1){this.totalOrderPayment=0,(null==e?void 0:e.RemainigAmount)||(e.RemainigAmount=0),(null==e?void 0:e.SubTotal)&&(null!=e.OrderPayments&&e.OrderPayments.forEach(e=>{this.totalOrderPayment+=e.PayAmount&&e.PayAmount>0?Number(e.PayAmount):0}),e.RemainigAmount=this.totalOrderPayment-(t?Number(e.SubTotal.toFixed(5)):e.SubTotal)-e.DeliveryPersonDeliveryPrice-e.TotalInsuranceAmount),0==e.SubTotal&&(e.TotalInsuranceAmount>0||e.TotalInsuranceAmount)&&(e.pointOfSale.PaymentButtonDirectly||(e.RemainigAmount=-1*(null==e?void 0:e.TotalInsuranceAmount)))}validatePayment(e,t=!1){var r,i;if(e.OrderPayments&&e.OrderPayments.length&&!e.OrderPayments.some(e=>!e.PayTypeDocumentId)){if(e.Reservation&&e.PayedAmountReservation>0&&(null===(r=e.OrderPayments)||void 0===r?void 0:r.length)>1&&(null===(i=e.OrderPayments)||void 0===i||i.forEach(e=>{(null==e?void 0:e.Amount)&&!(null==e?void 0:e.PayAmount)&&(e.PayAmount=e.Amount)})),!(e.OrderPayments.length>1&&e.OrderPayments[e.OrderPayments.length-1].PayAmount<e.OrderPayments[e.OrderPayments.length-1].Amount||e.OrderPayments.length>1&&!e.OrderPayments[e.OrderPayments.length-1].PayAmount)){if(100!=e.Discount||"1"!=e.DiscountType){if(!e.OrderPayments||0==e.OrderPayments.length)return this.toastr.warning(this.translate.instant("messages.paymentRequired")),!1;if(e.OrderPayments.filter(e=>!e.PayTypeDocumentId)[0])return this.toastr.warning(this.translate.instant("messages.paymentRequired")),e=this.recalculateOrderObject(e),!1;if(e.OrderPayments.filter(e=>!e.Amount||0==e.Amount)[0]&&e.OrderDetails.filter(e=>e.IsCancelled).length<e.OrderDetails.length&&e.SubTotal>0){let t=e.OrderPayments.filter(e=>!e.Amount||0==e.Amount)[0],r=e.OrderPayments.indexOf(t);return this.toastr.warning(this.translate.instant("messages.PaymentAmountCannotbeZero")),this.setFocusById("PayAmount"+r),!1}let r=e.OrderPayments.map(e=>Number(e.Amount)).reduce((e,t)=>e+t,0),i=Number(e.SubTotal-r);if(1==e.IsMobileOrder||1==e.IsCallCenter)return!0;if(i>.01)return this.toastr.warning(this.translate.instant("messages.OrderPaymentMustbeGreaterthanorequaltototal")),!1;if(t&&this.settingobj.PreventClosingWithoutFullPayment&&e.OrderPayments.filter(e=>!e.PayAmount||0==e.PayAmount)[0]&&e.OrderPayments.filter(e=>e.Amount>0)[0]){let t=e.OrderPayments.filter(e=>!e.PayAmount||0==e.PayAmount)[0],r=e.OrderPayments.indexOf(t);return this.toastr.warning(this.translate.instant("messages.PaymentAmountCannotbeZero")),this.setFocusById("PayAmount"+r),!1}if(e.Reservation&&e.PayedAmountReservation>0&&!this.checkCreditPayment(e))return this.toastr.warning(this.translate.instant("messages.MustAddCreditPayment")),!1;if(e.pointOfSale&&e.pointOfSale.IsCallCenter&&(!e.CustomerDocumentId||!e.CustomerAddressDocumentId||!e.CallCenterBranch))return e.CustomerDocumentId&&e.CustomerAddressDocumentId||this.toastr.info(this.translate.instant("messages.MustSelectCustomer")),e.CallCenterBranch||this.toastr.info(this.translate.instant("Shared.BranchName")+"!"),e=this.checkCallCenter(e),!1;if(e.OtelPrimoRoomNo>0&&!this.checkCreditPayment(e))return this.toastr.warning(this.translate.instant("messages.MustAddCreditPayment")),!1;const o=this.orderPayTypelist.filter(e=>e.NoteIsRequired).map(e=>e.DocumentId);if(null==o?void 0:o.length){const t=e.OrderPayments.find(e=>o.includes(e.PayTypeDocumentId)&&!e.Note);if(t)return this.toastr.warning(this.translate.instant("messages.NoteIsRequiredForPayment")+t.PayTypeName),!1}}return!((e.paymentErrorFired||1==e.OrderPayments.length&&(e.OrderPayTypeId&&e.OrderPayments[0].PayTypeId!=e.OrderPayTypeId||e.OrderPayTypeDocumentId&&e.OrderPayments[0].PayTypeDocumentId!=e.OrderPayTypeDocumentId))&&!e.IsMobileOrder&&!e.IsCallCenter&&(e.OrderPayments=[],e.paymentErrorFired=!0,this.toastr.warning(this.translate.instant("messages.PleaseMakeSureOfOrderPayment")),1))}this.toastr.warning(this.translate.instant("messages.PleaseInsertPayAmountForEachPayment"))}else this.toastr.warning(this.translate.instant("messages.PleaseInsertPayAmountForEachPayment"))}getName(e){var t,r,i,o,n,a,s;return e?e.ProductProperties&&e.ProductProperties.Name&&!e.VolumeId&&!e.VolumeDocumentId?null!==(t=e.ProductProperties.Name)&&void 0!==t?t:"":this.defaultLanguage&&this.settingobj&&this.currentUserLanguage?this.settingobj.ShowBothNameAndForeignName&&e.ForiegnName&&""!=e.ForiegnName?(null!==(r=e.Name)&&void 0!==r?r:"")+" , "+(null!==(i=e.ForiegnName)&&void 0!==i?i:""):this.settingobj.NamesOfProductsBasedOnMainUserLang?!this.currentUserLanguage.includes(this.defaultLanguage)&&e.ForiegnName&&""!=e.ForiegnName?null!==(o=e.ForiegnName)&&void 0!==o?o:"":null!==(n=e.Name)&&void 0!==n?n:"":null!==(a=e.Name)&&void 0!==a?a:"":null!==(s=e.Name)&&void 0!==s?s:"":""}getNameForProduct(e){var t;let r="";return(null===(t=this.settingobj)||void 0===t?void 0:t.ShowProductCodeWithNameInOrderScreen)&&e.ProductNumber&&(r="-"+e.ProductNumber),`${this.getName(e)}${r}`}getTypeOfName(){return this.defaultLanguage&&this.settingobj&&this.currentUserLanguage&&this.settingobj.NamesOfProductsBasedOnMainUserLang?this.currentUserLanguage.includes(this.defaultLanguage)?1:2:1}getTypeName(e){var t,r,i,o,n,a;return e?this.defaultLanguage&&this.settingobj&&this.currentUserLanguage?this.settingobj.ShowBothNameAndForeignName&&e.ForeignName&&""!=e.ForeignName?(null!==(t=e.Name)&&void 0!==t?t:"")+" , "+(null!==(r=e.ForeignName)&&void 0!==r?r:""):this.settingobj.NamesOfProductsBasedOnMainUserLang?!this.currentUserLanguage.includes(this.defaultLanguage)&&e.ForeignName&&""!=e.ForeignName?null!==(i=e.ForeignName)&&void 0!==i?i:"":null!==(o=e.Name)&&void 0!==o?o:"":null!==(n=e.Name)&&void 0!==n?n:"":null!==(a=e.Name)&&void 0!==a?a:"":""}checkCreditPayment(e){if(e&&e.OrderPayments){let t=this.orderPayTypelist.filter(e=>20===e.PayType&&e.Id).map(e=>e.Id),r=this.orderPayTypelist.filter(e=>20===e.PayType&&e.DocumentId).map(e=>e.DocumentId);return!!e.OrderPayments.find(e=>t.includes(e.PayTypeId)||r.includes(e.PayTypeDocumentId))}return!1}checkAvailableQuantityBeforeSave(e){return new Promise(t=>{this.orderSer.checkAvailableQuantityBeforeSave(e).subscribe(e=>Object(i.a)(this,void 0,void 0,function*(){return t(!0),!0}),e=>(this.handeExeptionError(e.error),t(!1),!1))})}closeAsync(e,t=!1){return this.showLoader(t),this.updatePendingOrders(e,!0),new Promise(r=>{e.DocumentId?this.orderSer.UpdateOrder(e).subscribe(o=>Object(i.a)(this,void 0,void 0,function*(){var i;this.showSuccess(t),o&&1==o.Item1?(this.toastr.success(this.toastrMessage.GlobalMessages(o.Item1),"Order"),(null===(i=this.settingobj)||void 0===i?void 0:i.UseStocksAndPurchase)&&this.orderSer.UpdateItemsQuantities(e.DocumentId).subscribe(),o.Item2&&this.PrintToPrinterFromCloud(o.Item2,e.LanguageOptions)):(this.showFaild(t),this.toastr.error(this.toastrMessage.GlobalMessages(o),"Order")),r(o)}),e=>{this.showFaild(t),this.handeExeptionError(e.error),r(e)}):this.orderSer.CloseOrder(e).subscribe({next:i=>{var o;this.showSuccess(t),i&&i.Item4&&(null===(o=this.settingobj)||void 0===o?void 0:o.UseStocksAndPurchase)&&this.orderSer.UpdateItemsQuantities(i.Item4).subscribe(),i&&!i.Item1?this.toastr.success(this.toastrMessage.GlobalMessages(i),"Order"):1==i.Item1?(e.IntegrationSystem>0&&this.updateOrderStatus(0,e.ReferenceCode,"",e),this.toastr.success(this.toastrMessage.GlobalMessages(i.Item1),"Order"),1==i.Item2?this.toastr.info("Printed Successfully","Order"):this.toastr.error("Something wrong hapeens while printing","Order"),i.Item3&&this.PrintToPrinterFromCloud(i.Item3,e.LanguageOptions)):(this.showFaild(t),this.toastr.error(this.toastrMessage.GlobalMessages(i.Item1),"Order")),r(i)},error:e=>{this.showFaild(t),this.handeExeptionError(e.error),r(e)}})})}checkIsOnlinePay(e,t){if(e&&e.UsePaymentDevices&&e.PaymentDevices.length>0&&t.Paid){let r=e.PaymentDevices.map(e=>e.PayTypeDocumentId);return t.OrderPayments.filter(e=>r.includes(e.PayTypeDocumentId)).length>0}return!1}showLoader(e){this.errorForPaymentDevice=!1,e&&(this.requestStarted=!1,m.a.fire({title:this.translate.instant("setting.Connecting"),html:this.translate.instant("setting.Pleasewait"),timerProgressBar:!0,allowOutsideClick:!1,showConfirmButton:!1,allowEscapeKey:!1,didOpen:()=>{m.a.showLoading()}}))}showSuccess(e){this.errorInSaveOrder=!1,e&&(m.a.close(),m.a.fire({title:this.translate.instant("setting.Success"),text:this.translate.instant("Shared.Done"),icon:"success",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,showCancelButton:!0,cancelButtonText:this.translate.instant("Shared.Cancel")}).then(e=>{}))}showFaild(e){this.errorInSaveOrder=!0,e&&(this.errorForPaymentDevice=!0,m.a.close(),m.a.fire({title:"",text:this.translate.instant("setting.FaildConnect")+"!",icon:"error",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,showCancelButton:!0,cancelButtonText:this.translate.instant("Shared.Cancel")}).then(e=>{}))}PrintToPrinterFromCloud(e,t){if(e.Reports&&e.Reports.length||e.OrderDetailPrinters&&e.OrderDetailPrinters.length){var r=this.deepCopy(t);r.ReportsJson=void 0,r.JsonLangFile=this.getJsonLangforCloud();let i=localStorage.getItem("token"),o=localStorage.getItem("TenantId"),n=localStorage.getItem("PointOfSaleDocumentId"),a={Url:this.orderSer.common.rooturl.toString(),Token:i,LanguageOptions:r,TenantId:o,PointOfSaleDocumentId:n,Reports:e.Reports,OrderDetailPrinters:e.OrderDetailPrinters};this.orderSer.CompressGZip(JSON.stringify(a)).subscribe(e=>{e&&e.json&&(location.href="PrintToPrinter:"+e.json)})}}handeExeptionError(e){let t="";if(e.errors&&e.title)this.toastr.error(e.title),t=e.title;else try{let r=e.indexOf(" at "),i=e.substr(0,r);if(t=i,i.includes("UnAvailableQuantity")){let e=i.indexOf("UnAvailableQuantity"),t=i.substr(e+"UnAvailableQuantity".length);this.toastr.info(this.translate.instant("messages.NoAvailableQuantity")+" "+t,"Order")}else t.toLowerCase().includes("validate order")||this.toastr.error(i,"Order")}catch(e){this.toastr.error(e),t=e}if("string"==typeof t&&(t.toLowerCase().includes("validate order")||t.toLowerCase().includes("shiftbeforedo"))){this.requestStarted=!1,this.orderSer.stopLoaderOnError=!0,t.toLowerCase().includes("shiftbeforedo")||this.handelValidateOrderExeptionMessages(t);const e=document.getElementById("preloader-wrap");throw e&&(e.style.display="none"),new Error(t)}}handelValidateOrderExeptionMessages(e){e.toLowerCase().includes("please add setting to printer paths")?this.toastr.warning(this.translate.instant("messages.pleaseaddsettingtoprinterpaths")):e.toLowerCase().includes("make sure your tax printer is connected")?this.toastr.warning(this.translate.instant("messages.Makesureyourtaxprinterisconnected")):this.toastr.warning(e)}handelCustomPromo(e,t,r){var i,o,n;this.freeProducts=[];let a=e.Promos.map(e=>e.PromoProducts).reduce(function(e,t){return e.concat(t)},[]);if(a&&a.length>0){a=a.filter(t=>t.TakeProductDocumentId==e.DocumentId);const s=e.VolumeDocumentId||(null==t?void 0:t.VolumeDocumentId);(null==a?void 0:a.length)&&s&&(a=a.filter(t=>t.TakeProductVolumeDocumentId==s&&t.TakeProductDocumentId==e.DocumentId));let u=a[0];if(u&&((null===(i=u.GetProducts)||void 0===i?void 0:i.length)>0||(null===(o=null==u?void 0:u.PromoCustomProductDetails)||void 0===o?void 0:o.length)>0)){u.TakeProductQuantity||(u.TakeProductQuantity=1);let e=Number(t.ProductQuantity)/Number(u.TakeProductQuantity);if(Number(e)>0&&t.ProductQuantity===u.TakeProductQuantity){if(this.allproductlist&&this.allproductlist.length>0){if(u&&(null===(n=null==u?void 0:u.PromoCustomProductDetails)||void 0===n?void 0:n.length)){let e=null==u?void 0:u.PromoCustomProductDetails.map(e=>e.GetProductDocumentId);this.freeProducts=this.deepCopy(this.allproductlist.filter(t=>e.includes(t.DocumentId)))}else this.freeProducts=this.deepCopy(this.allproductlist.filter(e=>u.GetProducts.map(e=>e.GetProductDocumentId).includes(e.DocumentId)));this.freeProducts.forEach(e=>{e.Disabled||(e.Disabled=!1),e.FreeChecked||(e.FreeChecked=!1)})}t.IsParentPromo?this.freeProducts.forEach(i=>{let o=r.OrderDetails.findIndex(e=>e.ProductDocumentId==i.DocumentId&&e.ProductIndex==t.ProductIndex&&e.IsPromo);-1!=o&&(r.OrderDetails[o].ProductQuantity=u.GetProductQuantity*e,r.OrderDetails[o].PromoProductName=t.ProductName)}):(t.IsParentPromo=!0,t.IsPromo||(this.freeobj={promoProduct:u,orderDetail:t,dividForSameProduct:e,orderobj:r},1===this.freeProducts.length?this.selectFreeProducts(!0,0):(this.freeProductsSelectionLimit=u.GetProductQuantity,$("#modal-CustomPromo").modal("show"))))}}}}printOrderObj(e){e.OrderDetails.some(e=>e.StartTime&&!e.EndTime)?this.toastr.warning(this.translate.instant("messages.PleaseCloseOpendGame")):(this.isPrinting=!0,this.orderSer.PrintOrder(e).subscribe(t=>Object(i.a)(this,void 0,void 0,function*(){t&&1==t.Item1?(this.toastr.success(this.toastrMessage.GlobalMessages(t.Item1),"Order"),t.Item2&&this.PrintToPrinterFromCloud(t.Item2,e.LanguageOptions),e.PrintCount?e.PrintCount++:e.PrintCount=1):this.toastr.error(this.toastrMessage.GlobalMessages(t),"Order"),this.isPrinting=!1}),e=>{this.toastr.error(this.translate.instant("messages.Somethingwronghapeenswhileprinting")),this.isPrinting=!1}))}PrintPreviewOrder(e){this.isPrinting=!0,e.LanguageOptions||this.getReportTranslationObj(e),this.orderSer.PrintPreviewOrder(e).subscribe(e=>Object(i.a)(this,void 0,void 0,function*(){e&&this.toastr.success(this.toastrMessage.GlobalMessages(e)),this.isPrinting=!1}),e=>{this.toastr.error(this.translate.instant("messages.Somethingwronghapeenswhileprinting")),this.isPrinting=!1})}printMultiOrders(e){e.forEach(e=>{this.PrintPreviewOrder(e)})}permittedPrint(e){if(this.isAdmin)return!0;let t=this.validationList.CanPrint;return(!t||e.PrintCount>0)&&(t=this.validationList.CanPrintMoreThanOne),t}printOrder(e,t){var r;if(e.OrderDetails.some(e=>e.StartTime&&!e.EndTime))return void this.toastr.warning(this.translate.instant("messages.PleaseCloseOpendGame"));if((null===(r=this.settingobj)||void 0===r?void 0:r.UseMinimumCharge)&&e.MinimumChargeValue&&e.MinimumChargeValue>e.SubTotal)return void this.toastr.warning(this.translate.instant("messages.MinimumChargeValueShouldBe"));let i=!1;if(1==t){if(e.OrderDetails.forEach(e=>{0==e.Printed||null==e.Printed?(this.toastr.warning(this.translate.instant("messages.paymentprintorderwarning")),i=!1):i=!0}),0==i)return;return this.printOrderObj(e),!1}this.printOrderObj(e)}getValidationOptions(){return this.validationList={CanSuspendOrder:!1,CanAddExtraService:!1,CanAddDiscount:!1,CanAddTips:!1,CanAddCustomer:!1,CanViewPayment:!1,CanPrint:!1,CanPrintMoreThanOne:!1,CanSplitOrder:!1,CanSplitOrderAfterPrint:!1,CanSplitReceipt:!1,CanChangeTable:!1,CanViewCachierOperations:!1,CanViewSales:!1,CanViewClosedOrders:!1,CanCancelOrder:!1,CanCancelOrderAfterPrint:!1,CanCancelOrderAfterOrderPreparationTime:!1,CanChangeEndOfDayDate:!1,CanChangeDeliveryPrice:!1,CanChangeInsurancePrice:!1,CanChangeProductProperties:!1,CanAddDiscountForDetail:!1,CanCloseWithoutPrint:!1,CanAddCreditCustomer:!1,CanNotEditOrderForAnotherUser:!1,CanEditDeliveryInfoAfterSave:!1,CanViewTotalOfOrdersInHall:!1,CannotAddAndEditHallsAndTables:!1,VerifiedOrderByPinBeforeSave:!1,CanAddCancelReasonFromOrder:!1,CanEditTheCaptainInOrder:!1,CanEditTheWaiterInOrder:!1,CanEditPersonsCountAfterSave:!1,CanCancelService:!1,CanViewTotalLastOrders:!1,CanChangeQuantityAfterSaveForWeightedProduct:!1},this.clone(this.validationList)}showCustomerPopUp(e,t){e.DocumentId&&!t.CanEditDeliveryInfoAfterSave?this.toastr.info(this.translate.instant("messages.CanNotEditDeliveryInfoAfterSave")):this.orderSer.closeOrderFromPayment?(setTimeout(()=>{this.showDeliveryModal()},200),this.orderSer.closeOrderFromPayment=!1):this.showDeliveryModal()}showDeliveryModal(){$("#modal-40444").modal("show"),setTimeout(()=>{this.setFocusById("search_PhoneNumber")},300)}CheckISGrantedTo(e,t){let r=!1;return t.forEach(t=>{t.POSUserRoleOptions.forEach(t=>{if(t.Name==e&&t.IsGranted)return r=!0,!0})}),0!=r}grantOptionsForUser(e,t,r){var i=this.clone(t);return Object.keys(i).forEach(e?e=>{i[e]=!0}:e=>{i[e]=this.CheckISGrantedTo(e,r)}),i}routIfMissingData(e,t=""){switch(e){case"pointofsale":this.toastr.info(this.translate.instant("messages.MissingPointofsale")),this.router.navigateByUrl("/pointofsale");break;case"producttype":this.toastr.info("Missing Products !"),this.router.navigateByUrl("/serversync");break;case"setting":this.toastr.info("Missing settings !"),this.router.navigateByUrl("/POSsettings");break;case"ordertype":this.toastr.info("Missing OrderType !"),this.router.navigateByUrl("/serversync");break;case"orderpaytype":this.toastr.info("Missing OrderPayTypes !"),this.router.navigateByUrl("/serversync");break;case"pin":this.toastr.info(this.translate.instant("messages.MustPin")),this.router.navigateByUrl("/home");case"user":this.toastr.info(this.translate.instant("messages.MustCaptain")),setTimeout(()=>{this.router.navigateByUrl("/home")},100);break;case"workTime":this.toastr.info(this.translate.instant(t||"messages.MustLinkUserWithShift")),setTimeout(()=>{this.router.navigateByUrl("/home")},100);break;case"admin":this.toastr.info(this.translate.instant("messages.AdminAccessDenied")),setTimeout(()=>{this.router.navigateByUrl("/home")},100);break;default:this.router.navigateByUrl("/home")}}continueAfterPin(e,t=null){switch(e){case"CanCancelOrder":case"CanCancelOrderAfterPrint":$("#modal-Cancel").modal("show");break;case"CanSplitReceipt":this.splitReceipt();break;case"CanSplitOrder":this.splitOrChangeOrder(!0);break;case"CanChangeTable":this.splitOrChangeOrder(!1);break;case"ReturnOrder":this.router.navigateByUrl("/returnorder",{state:{PinUserId:this.orderobj.PinUserId}});break;case"CanPrintMoreThanOne":case"CanPrint":this.printOrder(this.orderobj),null==t||t.ClearOrderModel(),null==t||t.clearSuggestions();break;case"CanCancelOrderAfterOrderPreparationTime":null==t||t.openCancelOrder()}}handelDriverSettings(e){return e.Driver&&e.DriverDocumentId&&e.DeliveryPrice>0&&(e.DeliveryPersonDeliveryPrice||(e.DeliveryPersonDeliveryPrice=0),e.DeliveryPrice||(e.DeliveryPrice=0),e.Driver.NotIncludedInTotal?(e.DeliveryPersonDeliveryPrice+=Number(e.DeliveryPrice),e.SubTotal-=Number(e.DeliveryPrice),e.DeliveryPrice=0):e.Driver.FixedDeliveryPersonAmount&&e.Driver.DriverFixedAmount>0&&(e.DeliveryPersonDeliveryPrice+=Number(e.Driver.DriverFixedAmount),e.SubTotal-=Number(e.Driver.DriverFixedAmount),e.DeliveryPrice-=Number(e.Driver.DriverFixedAmount))),e}PrintOrderWithDataSet(e){let t=this.clone(e);this.orderSer.PrintOrderWithDataSet({Order:t,IsA4:!1}).subscribe(e=>{try{this.reprtresult=null==e?void 0:e.report,this.orderToPrint=null==e?void 0:e.orderToPrint,this.report.loadDocument(this.reprtresult),this.report.renderAsync();var t=new Stimulsoft.Report.Export.StiHtmlExportSettings,r=new Stimulsoft.Report.Export.StiHtmlExportService,i=new Stimulsoft.System.IO.TextWriter,o=new Stimulsoft.Report.Export.StiHtmlTextWriter(i);r.exportTo(this.report,o,t);var n=document.getElementById("StimulsoftId");n&&(n.innerHTML=i.getStringBuilder().toString())}catch(a){}},e=>{this.handeExeptionError(e.error)})}PrintPerview(e){if(e.OrderDetails.some(e=>e.StartTime&&!e.EndTime))return void this.toastr.warning(this.translate.instant("messages.PleaseCloseOpendGame"));let t=!1;return e.OrderDetails.forEach(e=>{0==e.Printed||null==e.Printed?(this.toastr.warning(this.translate.instant("messages.paymentprintorderwarning")),t=!1):t=!0}),0!=t?(this.orderSer.PrintOrderWithDataSet({Order:e,IsA4:!0}).subscribe(e=>{this.reprtresult=null==e?void 0:e.report,this.report.loadDocument(this.reprtresult),this.report.renderAsync();var t=new Stimulsoft.Report.Export.StiHtmlExportSettings,r=new Stimulsoft.Report.Export.StiHtmlExportService,i=new Stimulsoft.System.IO.TextWriter,o=new Stimulsoft.Report.Export.StiHtmlTextWriter(i);r.exportTo(this.report,o,t);var n=document.createElement("iframe");n.name="frame1",n.style.position="absolute",n.style.top="-1000000px",document.body.appendChild(n);var a=n.contentDocument||n.contentWindow.document;return a.open(),a.write("</head><body>"),a.write(i.getStringBuilder().toString()),a.write("</body></html>"),a.close(),setTimeout(function(){window.frames.frame1.focus(),window.frames.frame1.print(),document.body.removeChild(n)},500),!1},e=>{this.handeExeptionError(e.error)}),!1):void 0}UnselectCustomer(e){return e.DeliveryPrice=0,e.DeliveryPersonDeliveryPrice=0,e.DeliveryNetPrice=0,e.CustomerDocumentId=void 0,e.CustomerId=void 0,e.CustomerAddressDocumentId=void 0,e.CustomerName=void 0,e.CustomerPhone=void 0,e.Customer=new h.a,e.CustomerAddress=new T.a,e}updateOrderStatus(e,t,r,i=null){return new Promise(o=>{let n=JSON.parse(localStorage.getItem("clickedStatusList"));n||(n=[]);let a=n.filter(e=>e.OrderId==t)[0];a&&((new Date).getTime(),new Date(a.Date).getTime()),this.orderSer.updateOrderStatus({OrderStates:e,OrderId:t,Reason:null==r?void 0:r.Name,ReasonId:null==r?void 0:r.Id,ItemIdList:null==r?void 0:r.ItemIdList,Order:i,Integration:i.IntegrationSystem}).subscribe({next:e=>{this.toastr.success(this.toastrMessage.GlobalMessages(e)),o(!0)},error:e=>{var t;this.toastr.error(null===(t=null==e?void 0:e.error)||void 0===t?void 0:t.Message),o(!1)}}),$("#modal-YemekSepeti").modal("hide"),a?a.Date=new Date:n.push({OrderId:t,Date:new Date}),localStorage.setItem("clickedStatusList",JSON.stringify(n))})}getReportTranslationObj(e){let t,r;this.settingobj.CustomerReceiptReportLanguage1>0&&(t=this.getJsonLang(this.settingobj.CustomerReceiptReportLanguage1)),this.settingobj.CustomerReceiptReportLanguage2>0&&(r=this.getJsonLang(this.settingobj.CustomerReceiptReportLanguage2));let i=Object.keys(P.a),o=this.clone(P.a);i.forEach(e=>{t&&(o[e]=t[e]),r&&(o[e]+="\n"+r[e])});let n="ar";return 1==this.settingobj.ReportDirection&&(n="ar"),2==this.settingobj.ReportDirection&&(n="en"),e.LanguageOptions={CurrentUserLang:n,ReportsJson:o},e}getJsonLangforCloud(){let e="en.json";switch(this.settingobj.CustomerReceiptReportLanguage1){case 2:e="ar.json";break;case 3:e="tu.json";break;case 4:e="fr.json"}return window.location.href.replace("order",""),e}getJsonLang(e){switch(e){case 1:this.reportsJson=D.a;break;case 2:this.reportsJson=P.a;break;case 3:this.reportsJson=g.a;break;case 4:this.reportsJson=y.a;break;default:this.reportsJson=D.a}return this.reportsJson}selectFreeProducts(e,t){if(e){if(!1===this.freeProducts[t].FreeChecked&&(this.freeOrderDetail=new o.a,this.freeOrderDetails||(this.freeOrderDetails=[]),this.freeProducts[t].FreeChecked=e,this.selectedFreeProducts.push(this.freeProducts[t]),this.selectedFreeProducts.forEach(e=>{var t,r,i,o,n,a,s,u,d,l,c,m,h;if(e.FreeChecked){if(this.freeOrderDetail.PromoProductName=this.freeobj.orderDetail.ProductName,this.freeOrderDetail.IsPromo=!0,this.freeOrderDetail.ProductId=e.Id,this.freeobj.orderDetail.ProductIndex||0==this.freeobj.orderDetail.ProductIndex||(this.freeobj.orderDetail.ProductIndex=e.orderobj.OrderDetails.length),this.freeOrderDetail.ProductIndex=this.freeobj.orderDetail.ProductIndex,this.freeOrderDetail.ProductDocumentId=e.DocumentId,this.freeOrderDetail.ProductGroupDocumentId=e.ProductGroupDocumentId,this.freeOrderDetail.ProductGroupId=e.ProductGroupId,this.freeOrderDetail.ProductName=this.getName(e),this.freeOrderDetail.Product=this.deepCopy(e),(null===(i=null===(r=null===(t=this.freeobj)||void 0===t?void 0:t.promoProduct)||void 0===r?void 0:r.GetProducts)||void 0===i?void 0:i.length)&&(this.freeOrderDetail.VolumeDocumentId=null===(s=null===(a=null===(n=null===(o=this.freeobj)||void 0===o?void 0:o.promoProduct)||void 0===n?void 0:n.GetProducts)||void 0===a?void 0:a.find(t=>t.GetProductDocumentId==e.DocumentId))||void 0===s?void 0:s.GetProductVolumeDocumentId,this.setFreeDetailVolume(this.freeOrderDetail.Product)),this.freeOrderDetail.ProductPrice=0,this.freeOrderDetail.Product.Price=0,null===(l=null===(d=null===(u=this.freeobj)||void 0===u?void 0:u.promoProduct)||void 0===d?void 0:d.PromoCustomProductDetails)||void 0===l?void 0:l.length){const t=null===(h=null===(m=null===(c=this.freeobj)||void 0===c?void 0:c.promoProduct)||void 0===m?void 0:m.PromoCustomProductDetails)||void 0===h?void 0:h.find(t=>t.GetProductDocumentId==e.DocumentId);this.freeOrderDetail.VolumeDocumentId=null==t?void 0:t.GetProductVolumeDocumentId;const r=this.setFreeDetailVolume(this.freeOrderDetail.Product);if(t&&t.NewPrice&&(this.freeOrderDetail.ProductPrice=t.NewPrice,this.freeOrderDetail.Product.Price=t.NewPrice,this.freeOrderDetail.DiscountPercentage=0),t&&t.DiscountPercentage){let i=e.Price;if(this.freeOrderDetail.VolumeDocumentId&&r){const t=e.ProductVolumes.find(e=>r.DocumentId&&r.DocumentId==e.VolumeDocumentId||r.VolumeId&&r.VolumeId==e.VolumeId);t&&(i=t.Price)}this.freeOrderDetail.ProductPrice=i,this.freeOrderDetail.Product.Price=i,this.freeOrderDetail.DiscountPercentage=t.DiscountPercentage}}this.selectedFreeProducts.length>1?(this.freeOrderDetail.ProductQuantity=1,this.freeOrderDetails.forEach(e=>{e.ProductQuantity=1})):this.freeOrderDetail.ProductQuantity=this.freeobj.promoProduct.GetProductQuantity}}),this.freeOrderDetails.push(this.freeOrderDetail),1===this.freeProducts.length))return void this.confirmFreeProductsModel()}else{this.freeProducts[t].FreeChecked=e;const r=this.selectedFreeProducts.findIndex(e=>e.DocumentId===this.freeProducts[t].DocumentId);this.selectedFreeProducts.splice(r,1);const i=this.freeOrderDetails.findIndex(e=>e.ProductDocumentId===this.freeProducts[t].DocumentId);this.freeOrderDetails.splice(i,1),1===this.selectedFreeProducts.length&&1===this.freeOrderDetails.length&&(this.freeOrderDetails[0].ProductQuantity=this.freeobj.promoProduct.GetProductQuantity)}(this.freeobj.orderDetail.VolumeDocumentId&&this.freeobj.orderDetail.VolumeDocumentId.length>1||this.freeobj.orderDetail.VolumeFerpCode&&this.freeobj.orderDetail.VolumeFerpCode.length>1||this.freeobj.orderDetail.VolumeId)&&this.confirmFreeProductsModel()}setFreeDetailVolume(e){var t,r,i,o;if(this.freeOrderDetail.VolumeDocumentId){const n=null===(t=this.volumes)||void 0===t?void 0:t.find(e=>e.DocumentId==this.freeOrderDetail.VolumeDocumentId);return n&&(this.freeOrderDetail.VolumeId=n.Id,this.freeOrderDetail.ProductVolumName=this.getName(n),(null===(r=this.settingobj)||void 0===r?void 0:r.ShowVolumeAsProduct)&&(e.Name=this.freeOrderDetail.ProductName+` ${null!==(o=null===(i=this.settingobj)||void 0===i?void 0:i.VolumeAndProductNameSeparatorCharacter)&&void 0!==o?o:"/"} `+this.freeOrderDetail.ProductVolumName)),n}return null}confirmFreeProductsModel(){this.freeobj.orderobj.OrderDetails.push(...this.freeOrderDetails),$("#modal-CustomPromo").modal("hide"),this.freeProducts=[],this.freeobj={},this.freeOrderDetails=[],this.freeOrderDetail=new o.a,this.selectedFreeProducts=[],this.freeobj.orderobj&&(this.freeobj.orderobj.OrderDetails=[]),this.orderobj=this.recalculateOrderObject(this.orderobj)}closeFreeProductsModel(){$("#modal-CustomPromo").modal("hide"),this.freeProducts=[],this.freeobj={},this.freeOrderDetails=[],this.freeOrderDetail=new o.a,this.selectedFreeProducts=[],this.freeobj.orderobj&&(this.freeobj.orderobj.OrderDetails=[])}getMaxDiscountForUser(e,t,r,i){let o=100;if(!e){let e=r.map(e=>e.POSUserRoleOptions),n=[];e.forEach(e=>{let r=e.filter(e=>e.Name==t&&e.IsGranted)[0];r&&n.push(r)});let a=[];n&&n.length>0?a=n.map(e=>e.MaxDiscountValue):i[t]&&a.push(o);let s=Math.max.apply(null,a);o=s>0?s:0}return o}checkIfPersonSelected(e,t,r,i){if(i){if(r.Id&&e!=r.Id)return!0;if(!r.Id&&r.DocumentId&&t!=r.DocumentId)return!0}else{if(r.Id&&e==r.Id)return!0;if(!r.Id&&r.DocumentId&&t==r.DocumentId)return!0}return!1}callkeyboard(){this.orderSer.openkeyboard().subscribe()}setKeyBoardInput(e){this.KeyboardNgModel=e}clearSearch(){this.orderSer.customerList=[],this.orderSer.customerAddressList=[]}checkProductVolumeAndSides(e){var t,r,i,o,n,a;let s=e.Product;if((null===(t=this.orderSer.originalProductList)||void 0===t?void 0:t.length)&&(s=this.orderSer.originalProductList.find(t=>{var r;return t.DocumentId==(null===(r=e.Product)||void 0===r?void 0:r.DocumentId)})),(e.ProductVolumName||e.VolumeDocumentId||e.VolumeId||e.VolumeFerpCode)&&!(null===(r=null==s?void 0:s.ProductVolumes)||void 0===r?void 0:r.length)&&(e.ProductVolumName=void 0,e.VolumeDocumentId=void 0,e.VolumeId=void 0,e.VolumeFerpCode=void 0),(null===(i=e.OrderDetailSubItems)||void 0===i?void 0:i.length)&&!(null===(o=null==s?void 0:s.ProductSubItems)||void 0===o?void 0:o.length)&&!(null==s?void 0:s.IsCombo)){const t=null===(n=this.comboProducts)||void 0===n?void 0:n.find(e=>e.ProductDocumentId==s.DocumentId);(null===(a=null==t?void 0:t.ComboDetails)||void 0===a?void 0:a.length)||(e.OrderDetailSubItems=[])}}totalForAllPay(e){return(null==e?void 0:e.SubTotal)+(null==e?void 0:e.DeliveryPersonDeliveryPrice)+(null==e?void 0:e.TotalInsuranceAmount)}checkWorkTimeFinished(){var e,t,r,i,o;this.refreshDateAndTime();const n=null===(t=null===(e=this.orderSer.workTime)||void 0===e?void 0:e.WorkTimeDays)||void 0===t?void 0:t.find(e=>e.DayName.toLowerCase()==this.currentMachineDay.toLowerCase()&&e.IsDayActive);if(!n||!n.ToTime)return;let a="",s="",u=0;const d=this.getDateFromTime(n.ToTime);(null===(r=this.orderSer.workTime)||void 0===r?void 0:r.ExitSystemWhenShiftEnd)&&this.currentMachineTime>=this.getTimeString(d)?(s="Order.ShiftEnded",a="close",this.orderSer.shiftAlertFired=!1):(null===(i=this.orderSer.workTime)||void 0===i?void 0:i.AlertBeforeEnd)&&(d.setMinutes(d.getMinutes()-(null===(o=this.orderSer.workTime)||void 0===o?void 0:o.AlertBeforeEnd)),this.currentMachineTime>=this.getTimeString(d)&&!this.orderSer.shiftAlertFired&&(s="Order.ShiftAlert",a="alert",u=this.getDateFromTime(n.ToTime).getMinutes()-this.getDateFromTime(this.currentMachineTime).getMinutes(),setTimeout(()=>{this.orderSer.shiftAlertFired=!1},6e4*u),this.orderSer.shiftAlertFired=!0)),a&&s&&m.a.fire({title:this.translate.instant("messages.Warning")+"!",text:(u||"")+this.translate.instant(s),icon:"warning",confirmButtonColor:"#3085d6",backdrop:!1,confirmButtonText:this.translate.instant("Shared.Ok")}).then(e=>{e.isConfirmed&&"close"==a&&this.routIfMissingData("workTime",s)})}getDateFromTime(e){const[t,r]=e.split(":").map(Number),i=new Date;return i.setHours(t,r,0,0),i}getScalerWeight(){return new Promise(e=>{this.orderSer.GetScalerWeight().subscribe(t=>Object(i.a)(this,void 0,void 0,function*(){e(t)}),t=>{this.handeExeptionError(t.error),e(0)})})}static getDefaultCustomerGroup(e){if(e&&e.length>0){let t=e.find(e=>e.Id>0&&e.DefaultGroup);return t||(t=e.find(e=>e.Id>0)),t||(t=e.find(e=>e.DefaultGroup)),t}return null}updatePendingOrders(e,t=!1){var r,i,o;(null===(r=this.orderSer.settings)||void 0===r?void 0:r.UsePendingOrders)&&(this.pendingOrders=p.a.getByKey(this.pendingOrdersKey)||[],(null==e?void 0:e.Serial)&&1==(null===(i=e.OrderType)||void 0===i?void 0:i.Value)&&(this.pendingOrders.find(t=>t.Serial==e.Serial)&&(this.pendingOrders=this.pendingOrders.filter(t=>t.Serial!=e.Serial)),t||!(null===(o=null==e?void 0:e.OrderDetails)||void 0===o?void 0:o.length)||e.DocumentId||this.pendingOrders.push(e),p.a.addOrUpdate(this.pendingOrdersKey,this.pendingOrders)),this.pendingOrdersCount=this.pendingOrders.filter(t=>t.Serial!=(null==e?void 0:e.Serial)).length)}openPendingOrders(){this.pendingOrders=p.a.getByKey(this.pendingOrdersKey)||[],this.pendingOrders=this.pendingOrders.filter(e=>{var t;return e.Serial!==(null===(t=this.orderobj)||void 0===t?void 0:t.Serial)}),$("#modal-PendingOrders").modal("show")}selectPendingOrder(e){this.orderobj=e,$("#modal-PendingOrders").modal("hide")}isOrderPreparationTimeFinished(e,t=!1){var r,i,o;let n=(null===(r=this.orderSer.settings)||void 0===r?void 0:r.DefaultOrderPreparationTimeInMinutes)?null===(i=this.orderSer.settings)||void 0===i?void 0:i.DefaultOrderPreparationTimeInMinutes:0;if(t){let t=Math.max(...null===(o=e.OrderDetails.filter(e=>{var t;return(null===(t=e.Product)||void 0===t?void 0:t.ProductPeriodTime)>0}))||void 0===o?void 0:o.map(e=>{var t;return null===(t=e.Product)||void 0===t?void 0:t.ProductPeriodTime}));t>n&&(n=t)}if(!(null==e?void 0:e.CreationTime)||!n)return!1;const a=new Date(null==e?void 0:e.CreationTime),s=new Date(a.getTime()+60*n*1e3)<new Date;return s&&(e.IsPreparationTimeFinished=!0),!t&&s&&this.toastr.info(this.translate.instant("Order.PreparationTimeFinished")),s}}return e.\u0275fac=function(t){return new(t||e)(f["\u0275\u0275directiveInject"](x.a),f["\u0275\u0275directiveInject"](O.a),f["\u0275\u0275directiveInject"](S.b),f["\u0275\u0275directiveInject"](b.a),f["\u0275\u0275directiveInject"](C.b),f["\u0275\u0275directiveInject"](A.e))},e.\u0275dir=f["\u0275\u0275defineDirective"]({type:e,features:[f["\u0275\u0275InheritDefinitionFeature"]]}),e})()},"9qFR":function(e,t,r){"use strict";r.d(t,"a",function(){return i.a}),r.d(t,"b",function(){return s}),r.d(t,"f",function(){return u.h}),r.d(t,"h",function(){return u.j}),r.d(t,"c",function(){return u.b}),r.d(t,"d",function(){return u.d}),r.d(t,"e",function(){return u.g}),r.d(t,"g",function(){return u.i}),r.d(t,"i",function(){return u.k});var i=r("mMi5"),o=(r("4XzM"),r("fXoL")),n=r("tk/3"),a=r("LNWR");let s=(()=>{class e{constructor(e,t){this.http=e,this.common=t}firstOpen(){return this.http.get(this.common.rooturl+"/Customer/FirstOpen")}getCreditCustomers(){return this.http.get(this.common.rooturl+"/Customer/GetCreditCustomersAsync")}getById(e){return this.http.get(this.common.rooturl+"/Customer/GetByDocumentID/"+e)}print(e){return this.http.post(this.common.rooturl+"/Customer/print/",e)}getGrideList(){return this.http.get(this.common.rooturl+"/Customer/GetGrideList")}preAddUpdate(){return this.http.get(this.common.rooturl+"/Customer/PreAddUpdate")}getCustomerByDocumentId(e){return this.http.get(this.common.rooturl+"/Customer/GetCustomerByDocumentId/"+e)}Pagination(e){return this.http.get(this.common.rooturl+"/Customer/Pagination/"+e)}Transactions(e,t){return"Post"==t?this.http.post(this.common.rooturl+"/Customer/InsertCustomerFromScreen/",e):"Edit"==t?this.http.put(this.common.rooturl+"/Customer/UpdateCustomer/",e):"Delete"==t?this.http.delete(this.common.rooturl+"/Customer/DeleteCustomerAsync/"+e.DocumentId):void 0}insertCustomersFromExcel(e){return this.http.post(this.common.rooturl+"/Customer/InsertCustomersFromExcel/",e)}}return e.\u0275fac=function(t){return new(t||e)(o["\u0275\u0275inject"](n.b),o["\u0275\u0275inject"](a.a))},e.\u0275prov=o["\u0275\u0275defineInjectable"]({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var u=r("TQQS")},Txa1:function(e,t,r){"use strict";r.d(t,"a",function(){return i});class i{}},U2wp:function(e,t,r){"use strict";r.d(t,"a",function(){return o});var i=r("kLqA");class o{constructor(){this.TotalSubItemDisountAmount=0,this.TaxDifferenceValue=0,this.UUID=i.Guid.create().toString()}}},bJ22:function(e,t,r){"use strict";r.d(t,"a",function(){return i});class i{}},cOv9:function(e,t,r){"use strict";r.d(t,"a",function(){return s});var i=r("ngTy"),o=r("bJ22"),n=r("mMi5"),a=r("Txa1");class s{constructor(){this.IntegrationCustomerId=null,this.IntegrationCustomerDocumentId=null,this.FromTaxScreen=!1,this.ReservationInfo={},this.requestStarted=!1,this.paymentErrorFired=!1,this.VisaSameOrderPayTimeCount=0,this.orderTypeChangedAfterSave=!1,this.Customer=new n.a,this.Driver=new a.a,this.CustomerAddress=new o.a,this.OrderType=new i.a,this.OrderMasterTaxes=[],this.OrderDetails=[],this.ReturnOrders=[],this.OrderPayments=[],this.OrderInsurance={}}}},e3ir:function(e,t,r){"use strict";r.d(t,"a",function(){return i});class i{}},kLqA:function(e,t,r){"use strict";t.__esModule=!0;var i=function(){function e(t){if(!t)throw new TypeError("Invalid argument; `value` has no value.");this.value=e.EMPTY,t&&e.isGuid(t)&&(this.value=t)}return e.isGuid=function(t){var r=t.toString();return t&&(t instanceof e||e.validator.test(r))},e.create=function(){return new e([e.gen(2),e.gen(1),e.gen(1),e.gen(1),e.gen(3)].join("-"))},e.createEmpty=function(){return new e("emptyguid")},e.parse=function(t){return new e(t)},e.raw=function(){return[e.gen(2),e.gen(1),e.gen(1),e.gen(1),e.gen(3)].join("-")},e.gen=function(e){for(var t="",r=0;r<e;r++)t+=(65536*(1+Math.random())|0).toString(16).substring(1);return t},e.prototype.equals=function(t){return e.isGuid(t)&&this.value===t.toString()},e.prototype.isEmpty=function(){return this.value===e.EMPTY},e.prototype.toString=function(){return this.value},e.prototype.toJSON=function(){return{value:this.value}},e.validator=new RegExp("^[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$","i"),e.EMPTY="00000000-0000-0000-0000-000000000000",e}();t.Guid=i},mMi5:function(e,t,r){"use strict";r.d(t,"a",function(){return i});class i{}},ngTy:function(e,t,r){"use strict";r.d(t,"a",function(){return i});class i{}},tiJv:function(e,t,r){"use strict";r.d(t,"a",function(){return i});class i{}},"un1/":function(e,t,r){"use strict";function i(e,t){const r=new Date(`1970-01-01 ${e}`),i=new Date(`1970-01-01 ${t}`),o=Math.abs(r.getTime()-i.getTime());return Math.floor(o/1e3)}function o(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());try{return JSON.parse(JSON.stringify(e))}catch(t){throw console.error("Deep copy failed for object:",e,t),new Error("Unable to deep copy object!")}}function n(e){e.Base.StiLicense.key="6vJhGtLLLz2GNviWmUTrhSqnOItdDwjBylQzQcAOiHlkHnETZDQa/PS+0KAqyGT4DpRlgFmGegaxKasr/6hj3WTsNszXi2AnvR96edDIZl0iQK5oAkmli4CDUblYqrhiAJUrUZtKyoZUOSwbjhyDdjuqCk8reDn/QTemFDwWuF4BfzOqXcdV9ceHmq8jqTiwrgF4Bc35HGUqPq+CnYqGQhfU3YY44xsR5JaAuLAXvuP05Oc6F9BQhBMqb6AUXjeD5T9OJWHiIacwv0LbxJAg5a1dVBDPR9E+nJu2dNxkG4EcLY4nf4tOvUh7uhose6Cp5nMlpfXUnY7k7Lq9r0XE/b+q1f11KCXK/t0GpGNnPL5Xy//JCUP7anSZ0SdSbuW8Spxp+r7StU/XLwt9vqKf5rsY9CN8D8u4Mc8RZiSXceDuKyhQo72Eu8yYFswP9COQ4lgOJGcaCv5h9GwR+Iva+coQENBQyY2dItFpsBwSAPvGs2/4V82ztLMsmkTpoAzYupvE2AoddxArDjjTMeyKowMI6qtTyhaF9zTnJ7X7gs09lgTg7Hey5I1Q66QFfcwK"}function a(e,t,r){return Math.min(Math.max(e,t),r)}function s(e){var t;return(null===(t=e.toString().split(".")[1])||void 0===t?void 0:t.length)||0}function u(e,t){return e.reduce((e,r)=>{const i=r[t];return e+("number"==typeof i?i:0)},0)}function d(e,t,r){t.loadDocument(r),t.renderAsync();var i=new e.Report.Export.StiHtmlExportSettings,o=new e.Report.Export.StiHtmlExportService,n=new e.System.IO.TextWriter,a=new e.Report.Export.StiHtmlTextWriter(n);o.exportTo(t,a,i);var s=document.createElement("iframe");s.name="frame1",s.style.position="absolute",s.style.top="-1000000px",document.body.appendChild(s);var u=s.contentDocument||s.contentWindow.document;return u.open(),u.write("</head><body>"),u.write(n.getStringBuilder().toString()),u.write("</body></html>"),u.close(),setTimeout(function(){window.frames.frame1.focus(),window.frames.frame1.print(),document.body.removeChild(s)},500),!1}function l(e){const t=e.getDate().toString().padStart(2,"0"),r=(e.getMonth()+1).toString().padStart(2,"0");return`${e.getFullYear()}-${r}-${t}`}function c(e){const t=e.replace(" PM","").replace(" AM","");return l(new Date(t))}r.d(t,"g",function(){return i}),r.d(t,"c",function(){return o}),r.d(t,"h",function(){return n}),r.d(t,"b",function(){return a}),r.d(t,"d",function(){return s}),r.d(t,"i",function(){return u}),r.d(t,"a",function(){return d}),r.d(t,"f",function(){return l}),r.d(t,"e",function(){return c})},zyXO:function(e,t,r){"use strict";r.d(t,"a",function(){return o});var i=r("fXoL");let o=(()=>{class e{constructor(){this.priceLang="fr"==JSON.parse(localStorage.getItem("langs"))?"fr-FR":"en-US"}ngOnInit(){}gridLoad(e,t){t.element.addEventListener("mousedown",e=>{if(e.target.classList.contains("e-rowcell")){t.isEdit&&t.endEdit();let r=parseInt(e.target.getAttribute("Index"));t.selectRow(r),t.startEdit()}})}gridCheckBoxBind(e,t,r,i){let o=t.getRowObjectFromUID(e.event.target.closest("tr").getAttribute("data-uid")).data;e.event.target.closest("td").getAttribute("index"),t.setCellValue(o[r],i,e.checked)}clone(e){return Object.assign({},e)}cloneList(e){return Object.assign([],e)}deepCopy(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());try{return JSON.parse(JSON.stringify(e))}catch(t){throw console.error("Deep copy failed for object:",e,t),new Error("Unable to deep copy object!")}}oldDeepCopy(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(t=new Date).setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var r=0,i=e.length;r<i;r++)t[r]=this.deepCopy(e[r]);return t}if(e instanceof Object){for(var o in t={},e)e.hasOwnProperty(o)&&(t[o]=this.deepCopy(e[o]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}clearAllIntervals(){const e=window.setInterval(function(){},Number.MAX_SAFE_INTEGER);for(let t=1;t<e;t++)window.clearInterval(t)}filterList(e,t){let r=[];return e&&e.length>0?t&&""!=t?(Object.keys(e[0]).forEach(i=>{"object"!=typeof e[0][i]&&e.filter(e=>e[i]&&e[i].toString().toLowerCase().includes(t.toString().toLowerCase())).forEach(e=>{-1===r.indexOf(e)&&r.push(e)})}),r):this.deepCopy(e):r}filterListByKey(e,t,r){let i=[];return e&&e.length>0?r&&""!=r?("object"!=typeof e[0][t]&&e.filter(e=>e[t]&&e[t].toString().toLowerCase().includes(r.toString().toLowerCase())).forEach(e=>{-1===i.indexOf(e)&&i.push(e)}),i):this.deepCopy(e):i}filterListByKeys(e,t,r){let i=[];return e&&e.length>0?r&&""!=r?(t.forEach(t=>{"object"!=typeof e[0][t]&&e.filter(e=>e[t]&&e[t].toString().toLowerCase().includes(r.toString().toLowerCase())).forEach(e=>{-1===i.indexOf(e)&&i.push(e)})}),i):this.deepCopy(e):i}distinct(e,t){return[...new Map(e.map(e=>[e[t],e])).values()]}getDecodedToken(e){return JSON.parse(atob(e.split(".")[1]))}clamp(e,t,r){return Math.min(Math.max(e,t),r)}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275dir=i["\u0275\u0275defineDirective"]({type:e}),e})()}}]);